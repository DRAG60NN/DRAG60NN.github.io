<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>fetch</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="background-color:#111;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;">
  <div id="status">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <button id="btn" style="display:none;margin-top:20px;" onclick="Telegram.WebApp.close()">üîô –ù–∞–∑–∞–¥</button>

<script>
  window.addEventListener('DOMContentLoaded', async () => {
    const status = document.getElementById('status');
    const btn = document.getElementById('btn');

    try {
      Telegram.WebApp.ready();

      const initDataUnsafe = Telegram?.WebApp?.initDataUnsafe;
      const codeFromInitData = initDataUnsafe?.start_param;
      const codeFromUrl = new URLSearchParams(window.location.search).get('code');
      const code = codeFromInitData || codeFromUrl;

      console.log("initDataUnsafe:", initDataUnsafe);
      console.log("–ö–æ–¥ –∏–∑ start_param:", codeFromInitData);
      console.log("–ö–æ–¥ –∏–∑ URL:", codeFromUrl);

      if (!code) {
        status.textContent = "‚ùå –ö–æ–¥ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ /start=–ö–û–î –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ ?code=–ö–û–î";
        return;
      }

      status.textContent = `üì¶ –ö–æ–¥: ${code} ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º...`;

      // –ó–∞–ø—Ä–æ—Å –∫ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º—É API
      const apiRes = await fetch(`https://buspaybot.icom24.ru/api/search/qr?botName=buspaybot&scannedCode=${code}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Telegram-WebApp-Data': Telegram.WebApp.initData
        },
        body: '{}'
      });

      const json = await apiRes.json();

      await fetch('https://buspay-proxy.onrender.com/store', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code, result: json })
      });

      status.textContent = "‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.";
      btn.style.display = 'inline-block';
    } catch (e) {
      console.error(e);
      status.textContent = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.";
      btn.style.display = 'inline-block';
    }
  });
</script>
</body>
</html>
