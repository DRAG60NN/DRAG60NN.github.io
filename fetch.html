<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Загрузка данных...</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="background-color:#222; color:#fff; display:flex; align-items:center; justify-content:center; height:100vh;">
  <div id="status">⏳ Загрузка...</div>

  <script>
    async function fetchTripData() {
      const statusEl = document.getElementById('status');

      if (!Telegram || !Telegram.WebApp || !Telegram.WebApp.initData) {
        statusEl.textContent = "Ошибка: WebApp не инициализирован";
        return;
      }

      console.log("initDataUnsafe:", Telegram.WebApp.initDataUnsafe);
      const code = Telegram.WebApp?.initDataUnsafe?.start_param;
      if (!code) {
        statusEl.textContent = "Ошибка: Код не передан";
        return;
      }

      try {
        const res = await fetch(`https://buspaybot.icom24.ru/api/search/qr?botName=buspaybot&scannedCode=${encodeURIComponent(code)}`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Telegram-WebApp-Data': Telegram.WebApp.initData
  },
  body: '{}'
});


        const data = await res.json();

        // Отправка данных на твой сервер
        await fetch('https://buspay-proxy.onrender.com/store', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ code, result: data })
});


        statusEl.textContent = "✅ Данные сохранены";
        Telegram.WebApp.close();
      } catch (err) {
        statusEl.textContent = "❌ Ошибка: " + err.message;
        console.error(err);
      }
    }

    window.addEventListener('DOMContentLoaded', fetchTripData);
  </script>
</body>
</html>
