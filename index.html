<!DOCTYPE html>
<html lang="ru">
  <script src="
https://telegram.org/js/telegram-web-app.js
"></script>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ë–∏–ª–µ—Ç</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background-color: #2b2b2b;
      color: #fff;
    }
    }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        /* –¢—É–º–±–ª–µ—Ä */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .toggle-label {
            font-weight: 500;
        }
        
        .toggle {
            position: relative;
            width: 50px;
            height: 28px;
        }
        
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--tg-theme-button-color, #3390ec);
        }
        
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
        .send-button {
            width: 100%;
            padding: 15px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: none;
            margin-top: 20px;
        }
        
        .send-button.active {
            display: block;
        }
        
        /* –ë–∏–ª–µ—Ç */
        .ticket-view {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .ticket-view.active {
            display: block;
        }
        
        .ticket-number {
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .ticket-info {
            text-align: left;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
        }
        
        .ticket-info div {
            margin: 8px 0;
        }
    .container {
      padding: 20px;
      padding-bottom: 80px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
    }
    .top-text {
      text-align: center;
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 15px;
      color: #fff;
    }
    .tab {
  position: relative;
  left: -16px;
  width: calc(100% + 32px);
      display: flex;
      justify-content: space-around;
      border-bottom: 1px solid #333;

    }
    .tab-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 16px;
      color: #ccc;
      padding: 10px 0;
      position: relative;
      cursor: pointer;
      user-select: none;
    }
    .tab-item.active {
      color: #e21a1a;
      font-weight: 500;
    }
    .tab-item.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 3px;
      background-color: #e21a1a;
    }
    .section {
      border-bottom: 1px solid #333;
      padding: 15px 0;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.3s ease-out forwards;
    }
    .label {
      color: #b0b0b0;
      font-size: 14px;
      font-weight: 300;
    }
    .value {
      font-size: 20px;
      font-weight: 500;
      margin-top: 5px;
    }
    .value-small {
      font-size: 14px;
      color: #aaa;
      margin-top: 3px;
      font-weight: 300;
    }
    /* –ö–Ω–æ–ø–∫–∞ "–ó–ê–ö–†–´–¢–¨" - –≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ */
    .bottom-button {
      width: 100%;
      padding: 14px 0;
      background-color: #e21a1a;
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      position: fixed;
      bottom: 4px;
      left: 2px;
      right: 2px;
      border-radius: 9px; /* –ó–∞–∫—Ä—É–≥–ª—è–µ–º —É–≥–ª—ã */
      cursor: pointer;
      user-select: none;
      box-shadow: 0 2px 6px rgba(226, 26, 26, 0.6);
      z-index: 1000;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon svg {
      width: 100%;
      height: 100%;
      fill: #aaa;
    }
    .screen {
      display: none;
    }
    .screen.active {
      display: block;
    }
    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .qr-container {
      background: #fff;
      padding: 20px;
      display: flex;
      justify-content: center;
      border-radius: 12px;
    }
    .qr-container img {
      width: 220px;
      height: 220px;
      border-radius: 12px;
    }
    .input-screen {
      padding: 30px 40px 0px 20px;
    }
    .input-screen input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
    }
    .input-screen button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      background-color: #e21a1a;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .photo-loader-block {
  margin-bottom: 24px;
}

.photo-loader-block input,
.photo-loader-block button {
  display: block;
  width: 100%;
  margin-bottom: 10px;
  font-size: 16px;
  padding: 12px;
  border-radius: 4px;
  border: none;
}

.photo-loader-block button {
  background-color: #e21a1a;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

.loader {
  border: 4px solid #ccc;
  border-top: 4px solid #e21a1a;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  animation: spin 1s linear infinite;
  margin: 10px auto 0;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

    /* –ë–ª–æ–∫ —Å–Ω–∏–∑—É */
.photo-controls {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #2b2b2b;
  padding: 20px;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
  z-index: 999;
}

/* –°–∫—Ä—ã—Ç—å input-—Ñ–∞–π–ª, —Å—Ç–∏–ª–∏–∑—É–µ–º label */
.photo-controls input[type="file"] {
  display: none;
}

.upload-label {
  display: block;
  width: 100%;
  text-align: center;
  padding: 12px;
  margin-bottom: 10px;
  background-color: #444;
  color: white;
  font-size: 16px;
  border-radius: 4px;
  cursor: pointer;
}

.photo-controls button {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  font-weight: bold;
  background-color: #e21a1a;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 10px;
}

/* –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –æ—Ç–¥–µ–ª—å–Ω–æ –≤—ã–¥–µ–ª–µ–Ω–∞ */
.submit-button {
  margin-top: 20px;
  background-color: #26a269;
}

.loader {
  border: 4px solid #ccc;
  border-top: 4px solid #e21a1a;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  animation: spin 1s linear infinite;
  margin: 10px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

    .loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
    .section .icon {
  margin-left: 12px; /* —Å–¥–≤–∏–≥–∞–µ—Ç –∏–∫–æ–Ω–∫—É –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–∞–≤–µ–µ */
}

.section span,
.section p {
  margin-left: 12px; /* —Å–¥–≤–∏–≥–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–∞–≤–µ–µ */
}
    .tab-container {
  padding: 0;
  margin: 0;
}

#authScreen {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background-color: #2b2b2b;
  display: flex;
  align-items: center;
  justify-content: center;
}

#authScreen .input-screen {
  max-width: 400px;
  width: 90%;
}

.admin-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 10001;
  display: flex;
  align-items: center;
  justify-content: center;
}

.admin-content {
  position: relative;
  background: #1e1e1e;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 0 20px #000;
  width: 90%;
  max-width: 420px;
  text-align: center;
}

.admin-content input {
  width: 100%;
  padding: 10px;
  margin: 8px 0;
  border: none;
  border-radius: 4px;
  font-size: 16px;
}

.admin-content button {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  background: #e21a1a;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.close-admin-button {
  position: absolute;
  top: 10px;
  right: 15px;
  background: none;
  border: none;
  color: white;
  font-size: 26px;
  font-weight: bold;
  cursor: pointer;
  z-index: 2;
}

#codeLoader {
  display: none;
  margin-left: 8px;
  font-size: 16px;
  animation: blink 1s linear infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.2; }
}
.custom-slider-wrapper {
  position: relative;
  top: -25px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 3px;
}

.slider-display {
  position: relative;
  top:-16px;
  display: flex;
  align-items: center;
}

#inputCountRange {
  flex: 1;
  appearance: none;
  height: 3px;
  border-radius: 2px;
  background: #555;
  outline: none;
  accent-color: #e21a1a;
}

#inputCountRange::-webkit-slider-thumb {
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #e21a1a;
  cursor: pointer;
  border: none;
  margin-top: -2px;
}

.slider-labels {
  display: flex;
  justify-content: space-between;  
  font-size: 14px;
  color: #bbb;
  padding: 0 4px;
  margin-top: 4px;
}
.input-invalid {
    border: 2px solid red !important;
    background-color: #ffe6e6;
  }
    /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ö–æ–Ω—Ç—Ä–æ–ª—å */
#qrBlockOverlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(100, 100, 100, 0.97); /* –ø–æ—á—Ç–∏ –±–µ–ª—ã–π, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å 15% */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    pointer-events: all; /* –±–ª–æ–∫–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
}

#qrBlockOverlay .loader {
    border: 8px solid rgba(255, 255, 255, 0.71);
    border-left-color: #8c0000;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}

/* —É–∂–µ –µ—Å—Ç—å @keyframes spin, –ø–æ—ç—Ç–æ–º—É –Ω–æ–≤—ã–π –Ω–µ –Ω—É–∂–µ–Ω */
    /* === –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ (–æ–≤–µ—Ä–ª–µ–π —Å–≤–µ—Ä—Ö—É) === */
.transport-menu-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 10002; /* –≤—ã—à–µ –∞–¥–º–∏–Ω-–º–µ–Ω—é –∏ –ø—Ä–æ—á–µ–≥–æ */
  display: none;  /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ */
  align-items: flex-start;
  justify-content: center;
  padding: 16px;
}

.transport-menu {
  width: 100%;
  max-width: 520px;
  background: #1f1f1f;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.5);
  padding: 14px 14px 18px;
}

/* –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –∫—Ä–µ—Å—Ç–∏–∫ */
.transport-menu__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 10px;
}
.transport-menu__title {
  font-size: 18px;
  font-weight: 600;
}
.transport-menu__close {
  background: none;
  border: none;
  color: #fff;
  font-size: 24px;
  line-height: 1;
  cursor: pointer;
}

/* —Ç–∞–±—ã */
.transport-tabs {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  margin-bottom: 10px;
}
.transport-tabs button {
  background: #2b2b2b;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 10px 8px;
  color: #ddd;
  font-size: 14px;
  cursor: pointer;
}
.transport-tabs button.active {
  background: #e21a1a;
  color: #fff;
  border-color: #e21a1a;
}

/* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫-–Ω–æ–º–µ—Ä–æ–≤ –º–∞—Ä—à—Ä—É—Ç–æ–≤ */
.route-buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  max-height: 50vh;
  overflow: auto;
  padding-right: 2px;
}
.route-buttons button {
  padding: 12px 8px;
  border: none;
  border-radius: 10px;
  background: #2b2b2b;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid #3a3a3a;
}
.route-buttons button:hover {
  transform: translateY(-1px);
}

/* –∫–Ω–æ–ø–∫–∞-—Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞–¥ –ø–æ–ª—è–º–∏ */
.transport-trigger {
  width: 100%;
  padding: 12px;
  margin-bottom: 12px;
  background: #444;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

/* –ø–æ–¥–ø–∏—Å—å –ø–æ–¥ —Å–µ—Ç–∫–æ–π (–ø–æ–¥—Å–∫–∞–∑–∫–∞) */
.transport-hint {
  margin-top: 10px;
  color: #aaa;
  font-size: 12px;
  text-align: center;
}
    /* –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ (–≤–º–µ—Å—Ç–æ input) */
.transport-trigger.inline-trigger {
  width: 100%;
  padding: 10px;
  margin: 0;
  background: #2b2b2b;
  color: #fff;
  border: 1px solid #444;
  border-radius: 8px;
  font-size: 14px;
  text-align: left;
}
.transport-trigger.inline-trigger:hover {
  background: #3a3a3a;
}
/* ==== Transport toggle (–ø–µ—Ä–µ–ø–∏—Å–∞–Ω–æ) ==== */
.transport-toggle{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  width:100%;
  margin:8px 0 14px 0; /* –∫–∞–∫ —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π */
}

.transport-option,
.transport-option:hover,
.transport-option:active,
.transport-option:focus{
  /* –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ª—é–±—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
  background:#2b2b2b !important; /* —Å–µ—Ä—ã–π —Ñ–æ–Ω –∫–∞–∫ —É –∏–Ω–ø—É—Ç–æ–≤ */
  color:#fff !important;          /* –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
  border:1px solid #fff !important; /* –±–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ –≤—Å–µ–≥–¥–∞ */
  box-shadow:none !important;
  outline:none !important;

  display:flex;
  align-items:center;   /* –∏–¥–µ–∞–ª—å–Ω–∞—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∞ */
  justify-content:center;
  height:44px;          /* –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–æ–∫–∏/–∏–Ω–ø—É—Ç–∞ */
  padding:0 12px;
  font-size:14px;
  font-weight:700;      /* —Ç–µ–∫—Å—Ç –≤—Å–µ–≥–¥–∞ –∂–∏—Ä–Ω—ã–π */
  border-radius:8px;
  cursor:pointer;
  white-space:nowrap;   /* —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–æ—Å—å –Ω–∞ 2 —Å—Ç—Ä–æ–∫–∏ */
}

/* –≤—ã–±—Ä–∞–Ω–Ω–∞—è ‚Äî —Ç–æ–Ω–∫–∞—è –∫—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ */
.transport-option.active{
  border:2px solid #d32f2f !important; /* –∫—Ä–∞—Å–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç */
}

/* –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ */
.transport-option:disabled{
  cursor:not-allowed;
  opacity:0.95;
}
.transport-option.active:disabled{
  border-color:#9a5a5a !important; /* —Å–µ—Ä–æ-–∫—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ */
}
    /* === LIVE: —Å—Ç–∏–ª–∏ –æ–Ω–ª–∞–π–Ω-–±–ª–æ–∫–∞ (KGT) === */
.live-box {
  margin-top: 14px;
  padding: 12px;
  border-radius: 12px;
  background: #1f1f1f;        /* —Ç—ë–º–Ω–æ-—Å–µ—Ä—ã–π, –∫–∞–∫ —Ñ–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
  border: 1px solid #2A2A2A;  /* —Ç–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ */
}

.live-head {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  align-items: baseline;
  margin-bottom: 6px;
}

.live-title {
  font-weight: 700;
  font-size: 14px;
  color: #fff;
}

.live-upd {
  font-size: 12px;
  color: #c9c9c9;
}

.live-direction {
  margin-top: 10px;
}

.live-direction .dir-caption {
  font-weight: 600;
  font-size: 13px;
  color: #eaeaea;
  margin-bottom: 6px;
}

.live-stops {
  list-style: none;
  margin: 0;
  padding: 0;
}

.live-stops li {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 10px;
  background: #242424;
  border: 1px solid #2d2d2d;
  margin-bottom: 6px;
}

.live-stops .stop-name {
  font-weight: 600;
  color: #ffffff;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 68%;
}

.live-stops .stop-time {
  font-weight: 600;
  color: #ff5252; /* –∞–∫—Ü–µ–Ω—Ç–Ω–æ–µ –≤—Ä–µ–º—è (–∫—Ä–∞—Å–Ω—ã–π) */
  white-space: nowrap;
  min-width: 72px;
  text-align: right;
}
    /* KGT: —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–∫–∏ –∏ –º–æ–¥–∞–ª–∫–∏ */
.small-btn {
  padding: 8px 12px;
  font-size: 13px;
  border-radius: 8px;
  background: #2b2b2b;
  color: #fff;
  border: 1px solid #444;
  cursor: pointer;
  font-weight:700;
}

.kgt-modal {
  position: fixed;
  inset: 0;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(0,0,0,0.6);
  z-index: 11000;
}

.kgt-modal-content {
  width: 92%;
  max-width: 760px;
  max-height: 80vh;
  overflow:auto;
  background: #131313;
  border-radius: 10px;
  padding: 14px;
  border: 1px solid #2b2b2b;
  color: #eaeaea;
}

.kgt-modal-close {
  float:right;
  background:none;
  border:none;
  color:#fff;
  font-size:20px;
  cursor:pointer;
}

#kgtModalTitle { margin: 0 0 8px 0; font-size:16px; font-weight:800; color:#fff;}
#kgtModalBody { margin-top:8px; }

.kgt-direction { margin-top:12px; }
.kgt-dir-title { font-weight:700; color:#fff; margin-bottom:6px; }
.kgt-stops { list-style:none; padding:0; margin:0; }
.kgt-stops li { display:flex; justify-content:space-between; gap:10px; padding:8px; border-radius:8px; background:#1d1d1d; border:1px solid #262626; margin-bottom:6px; }
.kgt-stop-name { color:#fff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:72%; font-weight:700; }
.kgt-stop-time { color:#ff6b6b; font-weight:700; min-width:72px; text-align:right; }

.kgt-vehicles { margin-top:10px; padding:8px; background:#151515; border:1px dashed #333; border-radius:8px; color:#ddd; }
.kgt-vehicle { display:flex; gap:10px; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #222; }
.kgt-vehicle:last-child { border-bottom: none; }
.kgt-vehicle .v-left { color:#fff; font-weight:700; }
.kgt-vehicle .v-right { color:#ff8b8b; min-width:120px; text-align:right; }


  </style>
</head>
<body>
<!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
<div id="authScreen" class="screen active">
  <div class="input-screen">
    <input id="authToken" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞" />
    <button onclick="checkAccess()">–í–æ–π—Ç–∏</button>
  </div>
</div>


  
  <!-- –≠–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö -->
  <div class="screen" id="inputScreen">
    <div class="input-screen">
      <div style="display: flex; gap: 10px; align-items: center;">
  </div>
    <button type="button" class="transport-trigger" onclick="openTransportMenu()">
  –í—ã–±—Ä–∞—Ç—å –Ω–æ–º–µ—Ä —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
</button>

      <input id="inputCarrier" placeholder="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–ü–ê–¢–ü-5)" />
      <input id="inputRoute" placeholder="–ú–∞—Ä—à—Ä—É—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: 3-—è –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è - –ú–æ–ª–æ–¥–µ–∂–Ω–∞—è)" />
      <input id="inputPlate" placeholder="–ì–æ—Å–Ω–æ–º–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: –≤747—Ä—Ä124)" />
      <!-- === KGT: –∫–æ–Ω—Ç—Ä–æ–ª & –º–æ–¥–∞–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏–±—ã—Ç–∏—è === -->
<div id="kgtControls" style="margin-top:8px;">
  <button id="kgtViewBtn" class="small-btn" style="display:none;" onclick="openKgtModal()">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–±—ã—Ç–∏–µ –∞–≤—Ç–æ–±—É—Å–∞</button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ KGT -->
<div id="kgtModal" class="kgt-modal" style="display:none;">
  <div class="kgt-modal-content">
    <button class="kgt-modal-close" onclick="closeKgtModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    <h3 id="kgtModalTitle">–û–Ω–ª–∞–π–Ω ‚Äî –º–∞—Ä—à—Ä—É—Ç <span id="kgtModalRoute">‚Äî</span></h3>
    <div id="kgtModalBody">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="kgt-modal-footer">
      <button id="kgtRefreshBtn" onclick="kgtRefreshNow()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <span id="kgtModalUpdated" style="margin-left:12px;color:#bbb"></span>
    </div>
  </div>
</div>
<!-- === /KGT === -->

      <div class="transport-toggle">
  <button type="button" class="transport-option active" data-type="bus">–ê–≤—Ç–æ–±—É—Å</button>
  <button type="button" class="transport-option" data-type="other">–¢—Ä–æ–ª–ª–µ–π–±—É—Å –∏ –¥—Ä.</button>
</div>
<input type="hidden" id="transportType" value="bus" />
      <div class="custom-slider-wrapper">
¬† <label for="inputCountRange">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤</label>
¬† <div class="slider-display">
¬† ¬† <div id="sliderValueBox"><span id="sliderValue">1</span></div>
¬† ¬† <input type="range" id="inputCountRange" min="1" max="5" step="1" value="1" oninput="updateCountLabel(this.value)" />
<div class="slider-labels">
</div>      
      
¬† </div>
¬† <input type="hidden" id="inputCount" value="1" />
</div>
      <div class="toggle-container">
                <span class="toggle-label">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</span>
                <label class="toggle">
                    <input type="checkbox" id="sendToBot" onchange="toggleSendButton()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <button class="send-button" id="sendButton" onclick="sendDataToTelegramBot()">
                üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
            </button>
    </div>
    
      <div class="photo-controls">
        <!-- === LIVE: –±–ª–æ–∫ –æ–Ω–ª–∞–π–Ω-–¥–∞–Ω–Ω—ã—Ö –ø–æ –º–∞—Ä—à—Ä—É—Ç—É (KGT) === -->
<div id="liveBox" class="live-box" style="display:none;">
  <div class="live-head">
    <div class="live-title">
      –û–Ω–ª–∞–π–Ω –ø–æ –º–∞—Ä—à—Ä—É—Ç—É: <span id="liveRouteTitle">‚Äî</span>
    </div>
    <div class="live-upd">
      –û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="liveForecast">‚Äî</span>
    </div>
  </div>
  <div id="liveDirections"></div>
</div>
<!-- === /LIVE === -->

    <button onclick="submitForm()" class="submit-button">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        <button id="adminButton" onclick="toggleAdminMenu()" style="display: none;">–ê–¥–º–∏–Ω-–º–µ–Ω—é</button>

      </div>
</div>
  <!-- === –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ (–æ–≤–µ—Ä–ª–µ–π) === -->
<div id="transportMenuOverlay" class="transport-menu-overlay">
  <div class="transport-menu">
    <div class="transport-menu__header">
      <div class="transport-menu__title">–í—ã–±–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∞</div>
      <button class="transport-menu__close" onclick="closeTransportMenu()">√ó</button>
    </div>

    <!-- –¢–∞–±—ã -->
    <div class="transport-tabs">
      <button id="tab-buses"        class="active" onclick="switchTransportTab('buses')">–ê–≤—Ç–æ–±—É—Å—ã</button>
      <button id="tab-trolleybuses"            onclick="switchTransportTab('trolleybuses')">–¢—Ä–æ–ª–ª–µ–π–±—É—Å—ã</button>
      <button id="tab-trams"                  onclick="switchTransportTab('trams')">–¢—Ä–∞–º–≤–∞–∏</button>
      <button id="tab-eBuses"                 onclick="switchTransportTab('eBuses')">–≠–ª–µ–∫—Ç—Ä–æ–±—É—Å—ã</button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤ (–∫–Ω–æ–ø–∫–∏) -->
    <div id="routesButtons" class="route-buttons"></div>

    <div class="transport-hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–æ–º–µ—Ä ‚Äî –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫ –∏ –º–∞—Ä—à—Ä—É—Ç –ø–æ–¥—Å—Ç–∞–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
  </div>
</div>

  
  <div id="adminPanel" class="admin-modal" style="display: none;">
  <div class="admin-content">
    <button class="close-admin-button" onclick="toggleAdminMenu()">√ó</button>

    <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>

    <input id="newTokenInput" placeholder="–ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω" />
    <button onclick="addToken()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω</button>

    <br /><br />

    <input id="removeTokenInput" placeholder="–£–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω" />
    <button onclick="removeToken()">–£–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω</button>

    <hr style="margin: 20px 0; border: 1px solid #444;" />

    <h3 style="margin-bottom: 10px;">–í—Å–µ —Ç–æ–∫–µ–Ω—ã</h3>
    <button onclick="loadTokens()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
    <ul id="tokenList" style="list-style: none; padding: 0; margin-top: 10px; font-size: 14px;"></ul>
  </div>
</div>




  <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ -->
  <div class="container screen" id="mainScreen">
    <div class="top-text">–î–µ–π—Å—Ç–≤—É–µ—Ç: <span id="countdown">15</span> —Å–µ–∫.</div>

    <div class="tab" id="tabs">
      <div class="tab-item active" onclick="switchTab('ticket', event)">
        <div style="display: flex; align-items: center; gap: 8px; color: #df1d1d;">
  <!-- SVG –∏–∫–æ–Ω–∫–∞ -->
  <svg width="25pt" height="25pt" viewBox="0 0 140 200" version="1.1" xmlns="http://www.w3.org/2000/svg">
<g id="#282525ff">
</g>
<g id="#ca211fff">
<path fill="#ca211f" opacity="1.00" d=" M 70.74 31.51 C 81.83 31.06 92.91 31.97 104.00 31.65 C 110.82 31.68 118.83 31.75 123.76 37.24 C 126.38 41.26 126.20 46.38 126.44 51.00 C 126.34 58.66 126.89 66.35 126.18 73.97 C 126.13 79.14 116.09 80.87 116.47 74.65 C 116.50 65.45 115.54 56.28 115.56 47.08 C 115.57 45.69 115.34 43.63 113.57 43.53 C 107.73 42.96 101.84 43.51 96.00 42.82 C 82.89 42.67 69.66 41.61 56.64 43.80 C 53.49 44.53 53.40 48.40 53.33 51.01 C 53.47 76.94 53.21 102.88 53.45 128.80 C 53.16 132.81 58.03 133.17 60.94 133.32 C 70.63 133.30 80.35 133.82 90.00 132.69 C 94.81 132.75 99.89 131.89 104.52 133.52 C 108.20 136.00 111.52 139.42 113.09 143.65 C 110.09 144.18 107.05 144.57 104.00 144.47 C 93.67 144.30 83.34 144.49 73.01 144.47 C 65.80 144.44 58.48 144.85 51.41 143.19 C 47.42 142.37 44.31 139.13 42.81 135.46 C 40.98 130.87 41.91 125.83 41.22 121.05 C 40.26 116.03 41.84 111.03 41.65 106.00 C 41.45 92.66 41.73 79.33 41.56 66.00 C 41.38 58.96 42.71 51.99 42.52 44.94 C 42.13 39.43 46.43 34.45 51.50 32.86 C 57.79 31.26 64.32 31.76 70.74 31.51 Z" />
<path fill="#ca211f" opacity="1.00" d=" M 68.37 61.26 C 73.12 59.96 78.13 60.67 82.99 60.50 C 88.54 60.77 94.22 59.93 99.67 61.24 C 103.71 62.20 105.50 69.85 100.86 71.18 C 96.28 71.86 91.62 71.39 87.00 71.50 C 80.91 71.36 74.70 72.00 68.72 70.55 C 63.85 70.33 64.55 62.58 68.37 61.26 Z" />
<path fill="#ca211f" opacity="1.00" d=" M 64.68 82.70 C 65.84 80.96 68.18 81.54 69.95 81.32 C 78.96 81.44 87.97 81.31 96.99 81.39 C 99.46 81.51 102.74 81.44 104.08 83.98 C 105.24 86.39 104.10 89.04 103.43 91.42 C 97.30 91.91 91.14 91.26 85.03 92.04 C 80.45 92.58 75.82 92.76 71.21 92.55 C 68.90 92.45 66.50 91.84 64.72 90.28 C 64.08 87.82 64.04 85.16 64.68 82.70 Z" />
<path fill="#ca211f" opacity="1.00" d=" M 128.32 82.18 C 135.66 80.80 143.65 81.01 150.42 84.48 C 159.08 88.52 166.43 96.43 168.25 105.98 C 169.07 113.30 168.10 121.07 164.58 127.62 C 161.38 132.62 157.39 137.50 151.87 140.04 C 146.34 142.68 140.25 145.18 133.99 144.15 C 127.83 143.22 122.06 140.49 116.85 137.17 C 103.10 126.01 101.54 102.06 115.19 90.19 C 118.96 86.69 123.26 83.47 128.32 82.18 M 140.85 110.87 C 138.45 112.75 136.36 115.89 132.99 115.77 C 129.89 116.26 128.45 113.04 126.38 111.41 C 125.37 110.10 123.49 110.58 122.90 112.01 C 123.95 116.03 126.51 119.66 129.79 122.18 C 132.45 123.32 135.71 122.73 137.99 120.97 C 142.23 117.97 146.00 114.19 148.74 109.75 C 149.88 108.03 149.63 105.86 149.87 103.90 C 146.01 104.87 143.82 108.53 140.85 110.87 Z" />
<path fill="#ca211f" opacity="1.00" d=" M 64.35 103.32 C 69.56 100.12 76.30 101.16 81.69 103.40 C 84.14 104.15 85.32 106.94 84.28 109.25 C 82.37 111.83 78.91 111.62 76.05 111.71 C 72.63 111.68 69.14 111.94 65.77 111.20 C 63.42 109.37 64.77 105.89 64.35 103.32 Z" />
  </g>
</svg>
</div>
        <div>1 081 124 924</div>
      </div>
      <div class="tab-item" onclick="switchTab('control', event)">     
  <div class="icon">
    <svg width="25pt" height="25pt" viewBox="0 0 132 166" version="1.1" xmlns="http://www.w3.org/2000/svg">
<g id="#252525ff">
</g>
<g id="#e8e8e8ff">
<path fill="#e8e8e8" opacity="1.00" d=" M 53.91 15.16 C 57.31 14.63 60.18 12.34 63.55 11.86 C 67.50 12.55 71.17 14.36 75.12 15.11 C 85.14 17.13 95.11 19.45 104.89 22.45 C 108.41 23.21 111.41 26.84 110.40 30.52 C 109.31 34.11 105.91 36.21 103.85 39.18 C 102.99 42.77 103.98 46.53 103.23 50.13 C 99.86 52.53 96.26 55.06 92.04 55.55 C 85.35 56.45 78.77 58.20 72.00 58.41 C 64.26 58.66 56.47 58.80 48.82 57.43 C 41.46 56.17 33.37 55.55 27.38 50.59 C 23.85 48.12 26.63 43.59 26.14 40.14 C 24.34 36.50 20.17 34.15 19.43 30.00 C 20.28 26.25 23.28 22.79 27.14 21.98 C 36.17 20.11 44.88 17.02 53.91 15.16 M 50.27 30.03 C 48.01 31.21 48.26 34.43 49.96 35.99 C 53.77 40.19 59.38 42.95 64.98 43.52 C 70.57 42.46 75.54 39.18 80.29 36.17 C 83.47 34.07 80.09 29.31 77.01 29.53 C 73.81 30.43 71.36 33.15 67.99 33.55 C 64.44 33.84 60.26 34.34 57.58 31.48 C 55.72 29.46 52.75 28.60 50.27 30.03 Z" />
<path fill="#e8e8e8" opacity="1.00" d=" M 32.12 63.04 C 33.24 61.67 35.18 62.85 36.58 63.05 C 40.52 64.30 44.41 66.76 46.13 70.67 C 47.88 74.09 49.25 78.04 52.62 80.24 C 56.39 82.76 60.86 84.87 65.51 84.35 C 70.64 83.89 75.29 81.33 79.32 78.27 C 83.10 75.57 82.58 69.98 86.06 67.04 C 88.87 64.77 92.21 62.66 95.93 62.58 C 97.22 63.38 97.73 64.52 97.47 66.02 C 97.17 71.65 94.25 76.67 91.67 81.53 C 88.89 87.02 83.13 89.80 78.55 93.54 C 75.93 95.86 72.28 95.55 69.03 95.63 C 64.68 95.61 60.33 95.76 55.99 95.49 C 51.94 95.26 48.62 92.66 45.31 90.60 C 40.02 87.39 37.23 81.61 34.52 76.30 C 32.76 72.21 30.74 67.51 32.12 63.04 Z" />
<path fill="#e8e8e8" opacity="1.00" d=" M 34.34 106.05 C 35.79 105.74 37.34 105.41 38.80 105.91 C 48.06 108.91 54.50 116.91 63.41 120.57 C 67.26 121.45 70.44 118.30 73.44 116.38 C 78.39 112.88 83.31 109.19 88.90 106.74 C 93.59 104.88 98.56 107.16 103.03 108.66 C 108.01 110.25 111.58 114.26 114.94 118.06 C 119.42 123.33 123.14 129.86 122.63 137.02 C 122.45 140.06 123.19 144.49 119.71 145.96 C 116.59 146.98 113.22 146.51 110.00 146.60 C 78.65 146.52 47.30 146.58 15.95 146.62 C 13.16 146.57 9.84 146.36 8.05 143.89 C 5.67 140.71 6.87 136.54 7.57 133.01 C 9.03 127.61 10.75 121.89 14.92 117.92 C 18.35 114.61 21.44 110.61 26.02 108.84 C 28.72 107.71 31.49 106.72 34.34 106.05 M 26.37 123.36 C 23.50 126.23 19.78 129.58 20.78 134.11 C 26.14 135.06 31.60 134.51 37.00 134.59 C 43.88 134.43 50.78 135.05 57.63 134.27 C 55.06 129.55 49.82 127.50 45.92 124.14 C 42.58 121.79 39.51 118.06 35.06 118.26 C 31.46 118.26 28.86 121.16 26.37 123.36 M 91.48 118.57 C 86.41 120.36 82.89 124.69 78.39 127.45 C 75.22 129.54 71.10 131.26 70.11 135.34 C 83.20 135.43 96.31 135.63 109.38 135.19 C 110.87 130.51 106.64 127.19 103.98 124.02 C 101.00 120.41 96.36 117.27 91.48 118.57 Z" />
  </g>
</svg>
        </div>
        –ö–æ–Ω—Ç—Ä–æ–ª—å
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –±–∏–ª–µ—Ç–∞ -->
    <div id="ticket" class="screen active">
      <div class="section">
        <div class="row">
          <div class="icon">
            <svg width="25pt" height="25pt" viewBox="0 0 132 166" version="1.1" xmlns="http://www.w3.org/2000/svg">
<g id="#252525ff">
</g>
<g id="#e8e8e8ff">
<path fill="#e8e8e8" opacity="1.00" d=" M 53.91 15.16 C 57.31 14.63 60.18 12.34 63.55 11.86 C 67.50 12.55 71.17 14.36 75.12 15.11 C 85.14 17.13 95.11 19.45 104.89 22.45 C 108.41 23.21 111.41 26.84 110.40 30.52 C 109.31 34.11 105.91 36.21 103.85 39.18 C 102.99 42.77 103.98 46.53 103.23 50.13 C 99.86 52.53 96.26 55.06 92.04 55.55 C 85.35 56.45 78.77 58.20 72.00 58.41 C 64.26 58.66 56.47 58.80 48.82 57.43 C 41.46 56.17 33.37 55.55 27.38 50.59 C 23.85 48.12 26.63 43.59 26.14 40.14 C 24.34 36.50 20.17 34.15 19.43 30.00 C 20.28 26.25 23.28 22.79 27.14 21.98 C 36.17 20.11 44.88 17.02 53.91 15.16 M 50.27 30.03 C 48.01 31.21 48.26 34.43 49.96 35.99 C 53.77 40.19 59.38 42.95 64.98 43.52 C 70.57 42.46 75.54 39.18 80.29 36.17 C 83.47 34.07 80.09 29.31 77.01 29.53 C 73.81 30.43 71.36 33.15 67.99 33.55 C 64.44 33.84 60.26 34.34 57.58 31.48 C 55.72 29.46 52.75 28.60 50.27 30.03 Z" />
<path fill="#e8e8e8" opacity="1.00" d=" M 32.12 63.04 C 33.24 61.67 35.18 62.85 36.58 63.05 C 40.52 64.30 44.41 66.76 46.13 70.67 C 47.88 74.09 49.25 78.04 52.62 80.24 C 56.39 82.76 60.86 84.87 65.51 84.35 C 70.64 83.89 75.29 81.33 79.32 78.27 C 83.10 75.57 82.58 69.98 86.06 67.04 C 88.87 64.77 92.21 62.66 95.93 62.58 C 97.22 63.38 97.73 64.52 97.47 66.02 C 97.17 71.65 94.25 76.67 91.67 81.53 C 88.89 87.02 83.13 89.80 78.55 93.54 C 75.93 95.86 72.28 95.55 69.03 95.63 C 64.68 95.61 60.33 95.76 55.99 95.49 C 51.94 95.26 48.62 92.66 45.31 90.60 C 40.02 87.39 37.23 81.61 34.52 76.30 C 32.76 72.21 30.74 67.51 32.12 63.04 Z" />
<path fill="#e8e8e8" opacity="1.00" d=" M 34.34 106.05 C 35.79 105.74 37.34 105.41 38.80 105.91 C 48.06 108.91 54.50 116.91 63.41 120.57 C 67.26 121.45 70.44 118.30 73.44 116.38 C 78.39 112.88 83.31 109.19 88.90 106.74 C 93.59 104.88 98.56 107.16 103.03 108.66 C 108.01 110.25 111.58 114.26 114.94 118.06 C 119.42 123.33 123.14 129.86 122.63 137.02 C 122.45 140.06 123.19 144.49 119.71 145.96 C 116.59 146.98 113.22 146.51 110.00 146.60 C 78.65 146.52 47.30 146.58 15.95 146.62 C 13.16 146.57 9.84 146.36 8.05 143.89 C 5.67 140.71 6.87 136.54 7.57 133.01 C 9.03 127.61 10.75 121.89 14.92 117.92 C 18.35 114.61 21.44 110.61 26.02 108.84 C 28.72 107.71 31.49 106.72 34.34 106.05 M 26.37 123.36 C 23.50 126.23 19.78 129.58 20.78 134.11 C 26.14 135.06 31.60 134.51 37.00 134.59 C 43.88 134.43 50.78 135.05 57.63 134.27 C 55.06 129.55 49.82 127.50 45.92 124.14 C 42.58 121.79 39.51 118.06 35.06 118.26 C 31.46 118.26 28.86 121.16 26.37 123.36 M 91.48 118.57 C 86.41 120.36 82.89 124.69 78.39 127.45 C 75.22 129.54 71.10 131.26 70.11 135.34 C 83.20 135.43 96.31 135.63 109.38 135.19 C 110.87 130.51 106.64 127.19 103.98 124.02 C 101.00 120.41 96.36 117.27 91.48 118.57 Z" />

          </div>
          <div>
            <div class="label">–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫</div>
            <div class="value" id="carrierOutput">–ö–ü–ê–¢–ü-5</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="icon">
            <svg width="38pt" height="42pt" viewBox="0 0 38 42" version="1.1" xmlns="http://www.w3.org/2000/svg">
<g id="#262626ff">
</g>
<g id="#dededeff">
<path fill="#dedede" opacity="1.00" d=" M 15.20 4.23 C 21.98 3.66 29.89 3.89 34.93 9.16 C 35.19 10.36 35.45 11.55 35.72 12.75 C 38.41 14.89 37.69 18.33 37.51 21.32 C 37.00 21.70 35.97 22.46 35.45 22.84 C 35.44 26.17 35.48 29.49 35.36 32.82 C 34.62 33.72 33.88 34.62 33.14 35.51 C 33.10 37.28 33.04 39.06 32.94 40.83 C 32.17 40.88 30.62 40.98 29.85 41.03 C 29.76 39.51 29.68 37.99 29.62 36.47 C 22.80 36.57 15.99 36.45 9.18 36.53 C 9.05 37.99 8.93 39.45 8.79 40.91 C 8.09 40.92 6.68 40.93 5.98 40.94 C 5.82 39.18 5.67 37.42 5.52 35.67 C 2.39 32.25 3.57 27.40 3.25 23.21 C 0.48 21.08 1.10 17.59 1.36 14.54 C 1.78 14.13 2.62 13.32 3.05 12.91 C 3.42 6.79 10.11 4.81 15.20 4.23 M 7.03 10.81 C 12.71 11.84 18.23 8.30 23.83 10.22 C 26.40 11.11 29.16 10.93 31.83 10.70 C 30.07 9.56 28.19 8.48 26.08 8.18 C 19.73 6.98 12.55 7.04 7.03 10.81 M 6.81 14.22 C 6.82 16.21 6.81 18.20 6.80 20.19 C 10.39 20.18 13.99 20.20 17.58 20.23 C 17.59 18.21 17.60 16.19 17.59 14.17 C 14.00 14.16 10.40 14.18 6.81 14.22 M 21.08 14.16 C 21.08 16.15 21.07 18.14 21.10 20.13 C 24.74 20.18 28.39 20.17 32.04 20.20 C 32.00 18.19 31.96 16.18 31.89 14.17 C 28.29 14.17 24.69 14.18 21.08 14.16 M 6.83 23.76 C 7.32 26.68 5.56 30.70 7.92 32.89 C 15.76 33.18 23.60 32.86 31.44 33.00 C 32.08 29.98 32.13 26.88 32.04 23.81 C 23.63 23.69 15.23 23.80 6.83 23.76 Z" />
<path fill="#dedede" opacity="1.00" d=" M 10.35 26.39 C 12.35 24.73 15.22 28.31 13.11 29.82 C 11.12 32.65 6.90 27.94 10.35 26.39 Z" />
<path fill="#dedede" opacity="1.00" d=" M 26.48 26.39 C 29.32 24.40 31.20 30.21 27.88 30.51 C 25.61 31.59 23.52 26.98 26.48 26.39 Z" />
</g>
</svg>
          </div>
          <div>
            <div class="value-small" id="routeOutput">3-—è –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è - –ú–æ–ª–æ–¥–µ–∂–Ω–∞—è</div>
            <div class="value" id="plateOutput">–≤447—Ä—Ä124</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="icon">
            <svg width="111pt" height="129pt" viewBox="0 0 111 129" version="1.1" xmlns="http://www.w3.org/2000/svg">
<g id="#242424ff">
</g>
<g id="#e7e7e6ff">
<path fill="#e7e7e6" opacity="1.00" d=" M 25.27 12.24 C 27.96 8.65 32.63 7.45 36.91 7.53 C 47.96 7.49 59.01 7.36 70.06 7.49 C 77.50 7.39 84.56 10.54 90.73 14.43 C 100.09 21.46 105.29 33.39 104.66 45.01 C 105.38 57.59 98.27 69.93 87.63 76.42 C 80.63 80.93 72.09 81.42 64.03 82.19 C 54.23 82.59 44.40 82.07 34.59 82.45 C 34.68 86.41 34.01 90.66 35.88 94.32 C 47.23 94.96 58.63 94.40 70.00 94.58 C 75.12 94.73 80.30 94.04 85.38 94.88 C 87.87 96.06 89.37 98.96 89.48 101.64 C 87.67 105.53 82.91 106.27 79.08 106.34 C 64.49 106.40 49.90 106.34 35.31 106.34 C 35.30 110.69 35.62 115.09 34.81 119.39 C 34.16 124.40 25.65 124.75 23.79 120.24 C 21.42 116.07 21.66 111.10 21.50 106.47 C 16.92 106.24 11.79 106.93 7.74 104.33 C 5.77 101.94 6.24 98.24 7.58 95.65 C 12.00 93.57 17.50 95.92 21.56 93.21 C 21.66 89.90 22.43 86.11 20.86 83.11 C 16.33 81.74 11.25 82.36 7.01 80.04 C 6.21 76.78 6.33 73.10 7.96 70.10 C 11.93 69.22 16.03 69.94 20.03 69.36 C 21.90 68.77 21.46 66.57 21.62 65.09 C 21.69 52.37 21.69 39.65 21.65 26.94 C 21.64 21.87 22.27 16.48 25.27 12.24 M 35.63 20.18 C 34.87 36.38 35.43 52.61 35.30 68.81 C 47.22 68.82 59.14 68.95 71.06 68.84 C 77.39 69.13 82.51 64.82 86.98 60.90 C 92.48 55.95 93.00 47.92 92.57 41.01 C 92.24 32.11 85.92 23.40 77.13 21.22 C 73.54 20.17 69.75 20.19 66.04 20.17 C 55.90 20.23 45.77 20.21 35.63 20.18 Z" />
</g>
</svg>
          </div>
          <div>
            <div class="label">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
            <div class="value" id="fareOutput">1 —à—Ç., –ü–æ–ª–Ω—ã–π, 44.00 ‚ÇΩ</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="icon">
            <svg width="126pt" height="145pt" viewBox="0 0 126 145" version="1.1" xmlns="http://www.w3.org/2000/svg">
<g id="#232323ff">
</g>
<g id="#e6e7e6ff">
<path fill="#e6e7e6" opacity="1.00" d=" M 31.81 10.08 C 32.99 4.98 40.95 4.10 43.45 8.61 C 44.86 12.74 44.34 17.20 44.53 21.49 C 56.49 21.60 68.45 21.41 80.41 21.59 C 80.89 16.48 79.76 9.74 84.56 6.36 C 88.09 3.86 92.56 6.85 93.73 10.46 C 94.85 14.04 94.39 17.85 94.47 21.54 C 102.42 20.96 111.41 21.62 117.17 27.85 C 119.79 30.11 120.73 33.58 120.58 36.94 C 120.54 66.32 120.66 95.70 120.52 125.07 C 120.86 130.58 116.15 134.46 111.84 136.96 C 108.59 138.96 104.65 138.67 100.99 138.75 C 75.65 138.67 50.32 138.74 24.98 138.72 C 19.02 138.67 11.98 138.04 8.27 132.70 C 5.57 129.83 4.23 125.97 4.48 122.05 C 4.45 94.35 4.48 66.64 4.41 38.94 C 3.95 33.24 7.59 28.13 11.90 24.82 C 17.91 21.62 24.94 21.32 31.60 21.48 C 31.54 17.69 31.20 13.85 31.81 10.08 M 16.59 55.59 C 16.17 75.39 16.56 95.20 16.33 115.00 C 16.50 118.08 15.96 121.53 17.74 124.26 C 20.50 125.94 23.91 125.43 27.00 125.57 C 54.10 125.27 81.22 125.85 108.31 125.29 C 109.35 120.60 109.74 115.79 109.62 110.99 C 109.42 92.53 109.83 74.06 109.39 55.59 C 78.46 55.39 47.52 55.30 16.59 55.59 Z" />
<path fill="#e6e7e6" opacity="1.00" d=" M 30.53 72.42 C 40.02 72.43 49.52 72.09 59.01 72.48 C 61.05 72.21 62.63 74.02 62.45 76.00 C 62.87 84.83 62.44 93.67 62.61 102.51 C 56.57 105.81 49.56 104.42 43.00 104.69 C 38.80 104.56 34.38 105.22 30.37 103.67 C 29.29 100.57 29.52 97.23 29.49 94.00 C 29.70 86.80 28.93 79.51 30.53 72.42 Z" />
</g>
</svg>
          </div>
          <div>
            <div class="label">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</div>
            <div class="value" id="dateOutput">--</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="icon">
            <svg width="144pt" height="149pt" viewBox="0 0 144 149" version="1.1" xmlns="http://www.w3.org/2000/svg">
<g id="#242424ff">
</g>
<g id="#eaeaeaff">
<path fill="#eaeaea" opacity="1.00" d=" M 61.54 9.16 C 74.23 7.30 87.24 9.25 99.00 14.29 C 106.80 16.99 112.93 22.67 118.95 28.08 C 123.48 32.81 127.66 38.04 130.23 44.11 C 134.78 54.48 138.89 65.50 138.53 77.00 C 137.40 89.48 134.25 102.26 126.61 112.44 C 118.97 123.06 109.14 132.93 96.46 137.13 C 86.34 140.34 75.69 142.95 65.00 141.51 C 57.73 140.47 50.46 138.85 43.68 135.98 C 30.05 129.00 18.79 117.54 12.00 103.81 C 5.33 89.21 3.34 72.16 8.35 56.74 C 10.82 46.23 17.14 37.18 24.09 29.14 C 29.48 23.67 35.36 18.39 42.53 15.37 C 48.67 12.77 54.90 10.11 61.54 9.16 M 64.61 21.31 C 55.12 23.40 45.35 26.32 37.93 32.91 C 31.99 37.36 28.00 43.74 23.89 49.78 C 19.93 55.67 19.68 62.97 18.12 69.69 C 16.52 76.63 18.82 83.57 19.96 90.40 C 21.36 99.02 27.07 106.02 32.50 112.54 C 42.54 122.67 56.61 129.13 71.00 128.82 C 83.62 129.33 96.23 124.79 106.21 117.16 C 110.42 114.08 113.46 109.77 116.83 105.86 C 120.45 101.57 121.89 96.04 123.64 90.84 C 124.70 87.68 125.50 84.41 125.55 81.07 C 125.71 73.43 126.39 65.40 123.02 58.29 C 119.32 47.14 111.83 37.39 102.23 30.68 C 95.54 25.29 86.93 23.60 78.80 21.61 C 74.17 20.45 69.29 20.30 64.61 21.31 Z" />
<path fill="#eaeaea" opacity="1.00" d=" M 69.59 33.78 C 73.33 33.21 78.57 35.58 78.27 40.00 C 78.63 47.66 77.83 55.33 78.53 62.98 C 84.44 60.17 89.22 55.40 95.29 52.88 C 98.04 51.55 100.39 54.23 101.96 56.15 C 104.38 58.89 100.90 62.06 99.03 64.02 C 93.09 68.81 86.60 72.89 80.31 77.21 C 77.08 79.15 73.62 81.88 69.63 81.33 C 65.96 78.94 64.34 74.33 64.55 70.09 C 64.66 61.04 64.56 51.99 64.63 42.95 C 64.48 39.27 66.38 35.62 69.59 33.78 Z" />
</g>
</svg>

          </div>
          <div>
            <div class="label">–í—Ä–µ–º—è –ø–æ–∫—É–ø–∫–∏</div>
            <div class="value" id="timeOutput">--:--</div>
          </div>
        </div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è —Å QR-–∫–æ–¥–æ–º -->
    <div id="control" class="screen">
      <div class="qr-container">
        <!-- –ü—Ä–∏–º–µ—Ä QR-–∫–æ–¥–∞, —Å—Å—ã–ª–∫–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=ExampleQRCode" alt="QR Code" />
      </div>
    </div>
  <div id="qrBlockOverlay">
    <div class="loader"></div>
</div>

</div>

  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç—å, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ -->
  <div class="pre-footer"></div>
  <div class="bottom-button" id="closeButton" onclick="closeApp()">–ó–ê–ö–†–´–¢–¨</div>
  <script>
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const inputScreen = document.getElementById('inputScreen');
    const mainScreen = document.getElementById('mainScreen');
    const countdownEl = document.getElementById('countdown');
    const dateOutput = document.getElementById('dateOutput');
    const timeOutput = document.getElementById('timeOutput');
    const closeButton = document.getElementById('closeButton');

    // –í—ã–≤–æ–¥—ã –¥–ª—è –±–∏–ª–µ—Ç–∞
    const carrierOutput = document.getElementById('carrierOutput');
    const routeOutput = document.getElementById('routeOutput');
    const plateOutput = document.getElementById('plateOutput');
    const fareOutput = document.getElementById('fareOutput');

    // –í–∫–ª–∞–¥–∫–∏ –∏ —ç–∫—Ä–∞–Ω—ã
    const tabs = document.querySelectorAll('.tab-item');
    const screens = document.querySelectorAll('#mainScreen > .screen');

    // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –≤–≤–µ–¥–µ–Ω–æ
    const defaultData = {
      carrier: '–ö–ü–ê–¢–ü-5',
      route: '3-—è –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è - –ú–æ–ª–æ–¥–µ–∂–Ω–∞—è',
      plate: '–≤447—Ä—Ä124',
      fare: '44.00',
      count: '1',
    };

    let countdownInterval;

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
    function switchTab(tabName, event) {
      tabs.forEach(tab => {
        if (tab.textContent.trim() === '–ö–æ–Ω—Ç—Ä–æ–ª—å' && tabName === 'control') {
          tab.classList.add('active');
        } else if (tab.textContent.trim() !== '–ö–æ–Ω—Ç—Ä–æ–ª—å' && tabName === 'ticket') {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω—ã –ø–æ –∏–º–µ–Ω–∏ –≤–∫–ª–∞–¥–∫–∏
      if (tabName === 'ticket') {
        document.getElementById('ticket').classList.add('active');
        document.getElementById('control').classList.remove('active');
      } else {
        document.getElementById('ticket').classList.remove('active');
        document.getElementById('control').classList.add('active');
      }
      if (tabName === 'control') {
    // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º overlay –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ö–æ–Ω—Ç—Ä–æ–ª—å
    document.getElementById('qrBlockOverlay').style.display = 'flex';
} else {
    // –ï—Å–ª–∏ —É—à–ª–∏ —Å –≤–∫–ª–∞–¥–∫–∏ –ö–æ–Ω—Ç—Ä–æ–ª—å, –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å overlay (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    document.getElementById('qrBlockOverlay').style.display = 'none';
}

    }

   function startCountdown() {
  let time = 15;
  countdownEl.textContent = time;

  const closeBtn = document.getElementById('closeButton');
  if (closeBtn) {
    closeBtn.classList.add('disabled'); // –±–ª–æ–∫–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ CSS
    closeBtn.onclick = null; // –≤—Ä–µ–º–µ–Ω–Ω–æ —É–±–∏—Ä–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
  }

  countdownInterval = setInterval(() => {
    time--;
    if (time <= 0) {
      clearInterval(countdownInterval);
      countdownEl.textContent = '0';

      if (closeBtn) {
        closeBtn.classList.remove('disabled'); 
        closeBtn.onclick = closeApp; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é
      }
    } else {
      countdownEl.textContent = time;
    }
  }, 1000);
}




    async function submitForm() {
  // –°—á–∏—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∏–Ω–ø—É—Ç–æ–≤
  const carrier = document.getElementById('inputCarrier').value.trim() || defaultData.carrier;
  const route = document.getElementById('inputRoute').value.trim() || defaultData.route;
  const plate = document.getElementById('inputPlate').value.trim() || defaultData.plate;
  const count = parseInt(document.getElementById('inputCount').value, 10) || defaultData.count;

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∞—Ä–∏—Ñ
  const selectedType = document.getElementById('transportType').value;
  const pricePerTicket = selectedType === 'bus' ? 48 : 40;
  const fare = count * pricePerTicket;

  // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
  carrierOutput.textContent = carrier;
  routeOutput.textContent = route;
  plateOutput.textContent = plate;
  fareOutput.textContent = `${count} —à—Ç., –ü–æ–ª–Ω—ã–π, ${fare} ‚ÇΩ`;

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
  const now = new Date();
  dateOutput.textContent = now.toLocaleDateString('ru-RU');
  timeOutput.textContent = now.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});

  // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤–≤–æ–¥–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π
  inputScreen.classList.remove('active');
  mainScreen.classList.add('active');

  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
  startCountdown();
}



function closeApp() {
  clearInterval(countdownInterval);
  inputScreen.classList.add('active');
  mainScreen.classList.remove('active');

  // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏–Ω–ø—É—Ç–æ–≤ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  const inputIds = ['inputCarrier', 'inputRoute', 'inputPlate', 'inputFare', 'inputCount'];
  inputIds.forEach(id => {
    const element = document.getElementById(id);
    if (element) {  // ‚Üê –î–û–ë–ê–í–ò–õ–ò –ü–†–û–í–ï–†–ö–£
      element.value = '';
    }
  });

  // –°–±—Ä–æ—Å –≤–∫–ª–∞–¥–æ–∫ –∫ –ø–µ—Ä–≤–æ–π
  switchTab('ticket');
  
  // –°–∫—Ä—ã—Ç—å KGT –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
  __kgtShowButton(false);
  selectedKgtId = null;
}

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–∫–ª–∞–¥–∫—É "1 070 004 271" –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ó–ê–ö–†–´–¢–¨"
    switchTab('ticket');

    // –ö–Ω–æ–ø–∫–∞ "–ó–ê–ö–†–´–¢–¨" –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
    function updateCloseButtonVisibility() {
      if (mainScreen.classList.contains('active')) {
        closeButton.style.display = 'block';
      } else {
        closeButton.style.display = 'none';
      }
    }

    // –°–ª–µ–¥–∏–º –∑–∞ —Å–º–µ–Ω–æ–π —ç–∫—Ä–∞–Ω–æ–≤ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏
    const observer = new MutationObserver(updateCloseButtonVisibility);
    observer.observe(mainScreen, { attributes: true, attributeFilter: ['class'] });

    // –ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤
    updateCloseButtonVisibility();

    function highlightField(id, isValid) {
  const el = document.getElementById(id);
  if (!el) return;
  if (isValid) {
    el.classList.remove('input-invalid');
  } else {
    el.classList.add('input-invalid');
  }
}


function recognizeFromPhoto() {
  const fileInput = document.getElementById('photoInput');
  const file = fileInput.files[0];
  document.getElementById('loadingOverlay').style.display = 'flex';

  if (!file) {
    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ.");
    document.getElementById('loadingOverlay').style.display = 'none';
    return;
  }

  const img = new Image();
  img.src = URL.createObjectURL(file);

  img.onload = async () => {
    const BASE_WIDTH = 1080;
    const DEBUG = false;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    const scale = img.width / BASE_WIDTH;

    // –®–∞–±–ª–æ–Ω –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Äî –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ (–¥–ª—è BASE_WIDTH), –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º
    const zones = {
      inputCarrier: [
        { x: 203, y: 942, width: 769, height: 94 },
        { x: 203, y: 942, width: 769, height: 94 }
      ],
      inputRoute: [
        { x: 218, y: 1106, width: 586, height: 136 },
        { x: 217, y: 1107, width: 759, height: 61 }
      ],
      inputPlate: [
        { x: 229, y: 1244, width: 371, height: 103 },
        { x: 230, y: 1174, width: 389, height: 75 }
      ],
      inputFare: [
        { x: 588, y: 2195, width: 50, height: 54 }
      ]
    };

    // –£–ª—É—á—à–µ–Ω–Ω—ã–π OCR —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –º–∞—Å—à—Ç–∞–±–æ–º
    async function extractTextFromZone(zone, label = '') {
      const { x, y, width, height } = zone;
      const sx = x * scale;
      const sy = y * scale;
      const sw = width * scale;
      const sh = height * scale;

      const regionCanvas = document.createElement('canvas');
      regionCanvas.width = sw;
      regionCanvas.height = sh;
      const regionCtx = regionCanvas.getContext('2d');

      // –£–ª—É—á—à–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
      regionCtx.filter = 'grayscale(100%) contrast(150%) brightness(110%)';
      regionCtx.drawImage(img, sx, sy, sw, sh, 0, 0, sw, sh);

      // –û—Ç–ª–∞–¥–∫–∞ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã—Ä–µ–∑–∫—É
      if (DEBUG) {
        const debugImg = document.createElement('img');
        debugImg.src = regionCanvas.toDataURL();
        debugImg.style.border = '1px solid red';
        debugImg.style.margin = '4px';
        debugImg.title = label;
        document.body.appendChild(debugImg);
      }

      const { data: { text } } = await Tesseract.recognize(regionCanvas, 'rus+eng');
      return text.trim().replace(/\s+/g, ' ');
    }

    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –∑–æ–Ω—ã, –∏–Ω–∞—á–µ ‚Äî –∏–∑ –∑–∞–ø–∞—Å–Ω–æ–π
    async function getTextWithFallback(field) {
      const primary = await extractTextFromZone(zones[field][0], `${field}-main`);
      if ((!primary || primary.length < 4) && zones[field].length > 1) {
        const fallback = await extractTextFromZone(zones[field][1], `${field}-fallback`);
        return fallback;
      }
      return primary;
    }

    function normalizeRecognizedData(carrier, route, plate, fare) {
  // carrier: –Ω–∏—á–µ–≥–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º, –∫—Ä–æ–º–µ –ø—Ä–æ–±–µ–ª–æ–≤
  carrier = carrier.trim().replace(/\s+/g, ' ');

  // route: –∫–∏—Ä–∏–ª–ª–∏—Ü–∞ + —Ç–∏—Ä–µ, —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç–∏—Ä–µ –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏
  route = route
    .replace(/[^\p{Script=Cyrillic}\- ]+/gu, '') // —É–±—Ä–∞—Ç—å –≤—Å—ë, –∫—Ä–æ–º–µ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã, –ø—Ä–æ–±–µ–ª–æ–≤, —Ç–∏—Ä–µ
    .replace(/‚Äî/g, '-')                          // –¥–ª–∏–Ω–Ω–æ–µ —Ç–∏—Ä–µ ‚Üí –æ–±—ã—á–Ω–æ–µ
    .replace(/\s*-\s*/g, ' - ')                  // –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–∏—Ä–µ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
    .replace(/\s+/g, ' ')                        // —É–±—Ä–∞—Ç—å –¥–≤–æ–π–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
    .trim();

  // plate: —Ç–æ–ª—å–∫–æ –º–∞–ª–µ–Ω—å–∫–∏–µ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –∏–∑ –ì–û–°–¢–∞ + —Ü–∏—Ñ—Ä—ã
  const validPlateLetters = ['–∞','–≤','–µ','–∫','–º','–Ω','–æ','—Ä','—Å','—Ç','—É','—Ö'];
  // plate: –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã ‚Üí —Ä—É—Å—Å–∫–∏–µ, —Ñ–∏–ª—å—Ç—Ä, –≤–∞–ª–∏–¥–∞—Ü–∏—è
const latinToCyrillicMap = {
  a: '–∞', b: '–≤', c: '—Å', e: '–µ', h: '–Ω', k: '–∫', m: '–º',
  n: '–Ω', o: '–æ', p: '—Ä', r: '—Ä', s: '—Å', t: '—Ç', u: '—É', x: '—Ö'
};

plate = plate
  .toLowerCase()
  .replace(/[^a-z–∞-—è0-9]/g, '') // —É–±—Ä–∞—Ç—å –≤—Å—ë –ª–∏—à–Ω–µ–µ, –∫—Ä–æ–º–µ –ª–∞—Ç–∏–Ω–∏—Ü—ã, –∫–∏—Ä–∏–ª–ª–∏—Ü—ã, —Ü–∏—Ñ—Ä
  .split('')
  .map(ch => {
    if (latinToCyrillicMap[ch]) return latinToCyrillicMap[ch]; // –ª–∞—Ç–∏–Ω—Å–∫–∞—è ‚Üí —Ä—É—Å—Å–∫–∞—è
    return ch; // –æ—Å—Ç–∞–≤–∏—Ç—å —Ü–∏—Ñ—Ä—ã –∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—É
  })
  .join('');

// –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä–∏–º –¥–≤–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞:
const isStandard = /^[–∞–≤–µ–∫–º–Ω–æ—Ä—Å—Ç—É—Ö]\d{3}[–∞–≤–µ–∫–º–Ω–æ—Ä—Å—Ç—É—Ö]{2}\d{2,3}$/.test(plate);
const isTrolley = /^\d{4}$/.test(plate);
plate = (isStandard || isTrolley) ? plate : '';

  // fare: –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2.00 –∏–ª–∏ 25)
  fare = fare.replace(/[^\d.,]/g, '');

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞: –æ–¥–Ω–æ —á–∏—Å–ª–æ, –≤–æ–∑–º–æ–∂–Ω–æ —Å —Ç–æ—á–∫–æ–π/–∑–∞–ø—è—Ç–æ–π
  const match = fare.match(/^\d{1,3}([.,]\d{1,2})?$/);
  fare = match ? match[0].replace(',', '.') : ''; // –µ—Å–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ ‚Äî –ø—É—Å—Ç–æ

  return { carrier, route, plate, fare };
}

    try {
      const carrierText = await getTextWithFallback('inputCarrier');
      let routeTextRaw = await getTextWithFallback('inputRoute');
      const plateText = await getTextWithFallback('inputPlate');
      const fareText = await extractTextFromZone(zones.inputFare[0], 'fare');

      const matchRoute = routeTextRaw.match(/(?:\d+[,.:])?\s*(.+)/);
      const routeText = matchRoute ? matchRoute[1] : routeTextRaw;
      
      const cleaned = normalizeRecognizedData(carrierText, routeText, plateText, fareText);

      document.getElementById('inputCarrier').value = cleaned.carrier;
      document.getElementById('inputRoute').value = cleaned.route;
      document.getElementById('inputPlate').value = cleaned.plate;
      document.getElementById('inputFare').value = cleaned.fare;

      highlightField('inputCarrier', cleaned.carrier.length >= 4);
      highlightField('inputRoute', cleaned.route.includes(' - '));
      highlightField('inputPlate', cleaned.plate.length >= 4); // –∏–ª–∏ 4 –¥–ª—è —Ç—Ä–æ–ª–ª–µ–π–±—É—Å–∞
      highlightField('inputFare', /^\d+(\.\d{1,2})?$/.test(cleaned.fare));



      alert("–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.");
    } catch (error) {
      alert("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: " + error.message);
    } finally {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  };

  img.onerror = () => {
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
    document.getElementById('loadingOverlay').style.display = 'none';
  };
}
    
    function updateCountLabel(value) {
¬† document.getElementById('sliderValue').textContent = value;
¬† document.getElementById('inputCount').value = value;
}

    window.addEventListener('DOMContentLoaded', () => {
  const accessGranted = localStorage.getItem('ticket_access_granted');
  if (accessGranted === 'true') {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('inputScreen').classList.add('active');

    // üëá –í–∞–∂–Ω–æ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –Ω–∞–¥–æ
    if (localStorage.getItem('is_admin') === 'true') {
      document.getElementById('adminButton').style.display = 'inline-block';
    }
  }
});


    const adminToken = 'ADMIN-SUPERUSER-g8F2kLm9';
    
    let allowedTokens = JSON.parse(localStorage.getItem('allowedTokens')) || ['Y7KD92', 'F2X9Z1', 'QW38GT'];

    async function checkAccess() {
  const token = document.getElementById('authToken').value.trim();
  const url = 'https://script.google.com/macros/s/AKfycbw7tOiFx5iMRiAyCOYh20gdmr53rlR7L75EnMWXfVLBuPNiA29vOfFUsAXxTVuBmZlJFw/exec';

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  document.getElementById('loadingOverlay').style.display = 'flex';

  if (token === adminToken) {
    // –í—Ö–æ–¥ –∫–∞–∫ –∞–¥–º–∏–Ω ‚Äî –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Ç–∞–±–ª–∏—Ü–µ
    localStorage.setItem('ticket_access_granted', 'true');
    localStorage.setItem('is_admin', 'true');
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('inputScreen').classList.add('active');
    document.getElementById('adminButton').style.display = 'inline-block';
    document.getElementById('loadingOverlay').style.display = 'none';
    return;
  }

  try {
    const response = await fetch(url, {
      method: 'POST',
      body: new URLSearchParams({ token })
    });

    const result = await response.text();

    if (result === 'valid') {
      localStorage.setItem('ticket_access_granted', 'true');
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('inputScreen').classList.add('active');

      if (localStorage.getItem('is_admin') === 'true') {
        document.getElementById('adminButton').style.display = 'inline-block';
      }
    } else {
      alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω.');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  } finally {
    document.getElementById('loadingOverlay').style.display = 'none';
  }
}


    async function addToken() {
  const token = document.getElementById('newTokenInput').value.trim();
  if (!token) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω');

  const url = 'https://script.google.com/macros/s/AKfycbw7tOiFx5iMRiAyCOYh20gdmr53rlR7L75EnMWXfVLBuPNiA29vOfFUsAXxTVuBmZlJFw/exec';

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'add',
        token: token
      })
    });

    const result = await res.text();
    if (result === 'added') {
      alert('–¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω!');
      document.getElementById('newTokenInput').value = '';
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: ' + result);
    }
  } catch (err) {
    console.error(err);
    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
  }
}


async function removeToken() {
  const token = document.getElementById('removeTokenInput').value.trim();
  if (!token) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');

  const url = 'https://script.google.com/macros/s/AKfycbw7tOiFx5iMRiAyCOYh20gdmr53rlR7L75EnMWXfVLBuPNiA29vOfFUsAXxTVuBmZlJFw/exec';

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'remove',
        token: token
      })
    });

    const result = await res.text();
    if (result === 'removed') {
      alert('–¢–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω!');
      document.getElementById('removeTokenInput').value = '';
    } else if (result === 'not_found') {
      alert('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.');
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + result);
    }
  } catch (err) {
    console.error(err);
    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
  }
}

    function toggleAdminMenu() {
  const panel = document.getElementById('adminPanel');
  panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
}

async function loadTokens() {
  const url = 'https://script.google.com/macros/s/AKfycbw7tOiFx5iMRiAyCOYh20gdmr53rlR7L75EnMWXfVLBuPNiA29vOfFUsAXxTVuBmZlJFw/exec?action=list';

  try {
    const res = await fetch(url);
    const data = await res.json();

    const list = document.getElementById('tokenList');
    list.innerHTML = ''; // –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫

    data.forEach(row => {
      const li = document.createElement('li');
      li.textContent = `üîë ${row.token} ‚Äî ${row.status || 'unknown'}`;
      list.appendChild(li);
    });
  } catch (err) {
    console.error(err);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤.');
  }
}
    /* === –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤ === */
const routesData = {
  buses: [
    { number: "2",  carrier: "–ò–ü –ë–∞–≥–∞–µ–≤ –î.–ë.", route: "–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª \"–í–æ—Å—Ç–æ—á–Ω—ã–π\" - –î–æ–º –£—á—ë–Ω—ã—Ö" },
    { number: "3",  carrier: "–û–û–û \"–°–¢–ö\"", route: "–ê–∫–∞–¥–µ–º–≥–æ—Ä–æ–¥–æ–∫ - –ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–í–æ—Å—Ç–æ—á–Ω—ã–π¬ª" },
    { number: "5",  carrier: "–ò–ü –î–æ–ª–≥—É—à–∏–Ω–∞ –ì.–ò.", route: "–°–ø–æ—Ä—Ç–∫–æ–º–ø–ª–µ–∫—Å ¬´–†–∞–¥—É–≥–∞¬ª - –û–ê–û ¬´–ö—Ä–∞—Å—Ñ–∞—Ä–º–∞¬ª" },
    { number: "6",  carrier: "–ò–ü –¢–∞–≥–∞—á–∞–∫–æ–≤ –í.–ì.", route: "–î–ö ¬´–ö–∏—Ä–æ–≤—Å–∫–∏–π¬ª - –ö–∞—Ä–¥–∏–æ—Ü–µ–Ω—Ç—Ä" },
    { number: "7",  carrier: "–û–û–û ¬´–≠–∫–∏–ø–∞–∂-–ì–û¬ª", route: "–î–ö \"–ö–∏—Ä–æ–≤—Å–∫–∏–π\" - –ê–≥—Ä–æ—Ç–µ—Ä–º–∏–Ω–∞–ª" },
    { number: "8",  carrier: "–û–û–û \"–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫\"", route: "–ø–æ—Å. –í–æ–¥–Ω–∏–∫–æ–≤ - –ö–∞—Ä–¥–∏–æ—Ü–µ–Ω—Ç—Ä" },
    { number: "9",  carrier: "–û–û–û \"–°–ö–ê–î\"", route: "–í–µ—Ä—Ö–Ω—è—è –ë–∞–∑–∞–∏—Ö–∞ - –ú–µ–∂–¥—É–≥–æ—Ä–æ–¥–Ω—ã–π –∞–≤—Ç–æ–≤–æ–∫–∑–∞–ª" },
    { number: "10", carrier: "–ö–ü–ê–¢–ü-7", route: "–ø–æ—Å. –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–æ–≤ - –û–ê–û ¬´–ö—Ä–∞—Å—Ñ–∞—Ä–º–∞¬ª" },
    { number: "11", carrier: "–ö–ü–ê–¢–ü-5", route: "—É–ª. 3-—è –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è - –ú–æ–ª–æ–¥–µ–∂–Ω–∞—è" },
    { number: "12", carrier: "–ö–ü–ê–¢–ü-7", route: "—Å–æ–≤—Ö–æ–∑ –£–¥–∞—á–Ω—ã–π - —Å—Ç.–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫-–°–µ–≤–µ—Ä–Ω—ã–π" },
    { number: "14", carrier: "–ö–ü–ê–¢–ü-5", route: "–ø–æ—Å. –û–≤–∏–Ω–Ω—ã–π - –ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω–∞—è –±–æ–ª—å–Ω–∏—Ü–∞" },
    { number: "18", carrier: "–ö–ü–ê–¢–ü-7", route: "–º–∫—Ä–Ω. –í–µ—Ä—Ö–Ω–∏–µ –ß–µ—Ä–µ–º—É—à–∫–∏ - –¢–µ—Ö–Ω–∏–∫—É–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –∏ —Å–µ—Ä–≤–∏—Å–∞" },
    { number: "18c",carrier: "–ö–ü–ê–¢–ü-7", route: "–º–∫—Ä–Ω. –í–µ—Ä—Ö–Ω–∏–µ –ß–µ—Ä–µ–º—É—à–∫–∏ - –û–ê–û ¬´–ö—Ä–∞—Å—Ñ–∞—Ä–º–∞¬ª" },
    { number: "19", carrier: "–ö–ü–ê–¢–ü-7", route: "–ü—Ä–∏—á–∞–ª - –°—Ç–µ–ª–∞" },
    { number: "21", carrier: "–û–û–û \"–°–¢–ö\"", route: "–ü–∞—Ä–∫ ¬´–ü—Ä–∏—â–µ–ø–∫–∞¬ª - –°–ø–æ—Ä—Ç–∑–∞–ª" },
    { number: "22", carrier: "–ö–ü–ê–¢–ü-7", route: "–ò–¢–ö - –ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å ¬´–Ø—Å–Ω—ã–π¬ª" },
    { number: "23", carrier: "–û–û–û \"–í–µ—Ç–µ—Ä–∞–Ω\"", route: "–õ–î–ö - –º–∫—Ä–Ω. –°–æ–ª–Ω–µ—á–Ω—ã–π" },
    { number: "26", carrier: "–ö–ü–ê–¢–ü-5", route: "–ü–ª–æ–¥–æ–≤–æ-—è–≥–æ–¥–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è - –ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω–∞—è –±–æ–ª—å–Ω–∏—Ü–∞" },
    { number: "27", carrier: "–ò–ü –Ø–ª—Ç–æ–Ω—Å–∫–∏–π –ê.–ú.", route: "–º–∫—Ä–Ω. –ü—Ä–µ–æ–±—Ä–∞–∂–µ–Ω—Å–∫–∏–π - –ü–æ–ª–∏–≥–æ–Ω" },
    { number: "30", carrier: "–ö–ü–ê–¢–ü-5", route: "–º–∫—Ä–Ω. –¢–∏—Ö–∏–µ –∑–æ—Ä–∏ - –°–ø–æ—Ä—Ç–∑–∞–ª" },
    { number: "31", carrier: "–ö–ü–ê–¢–ü-7", route: "–ê–∫–∞–¥–µ–º–∏—è –±–∏–∞—Ç–ª–æ–Ω–∞ - –õ–î–ö" },
    { number: "37", carrier: "–ö–ü–ê–¢–ü-7", route: "–û–∑–¥–æ—Ä–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å ¬´–ì—Ä–µ–Ω–∞–¥–∞¬ª - –ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π –≤–æ–∫–∑–∞–ª" },
    { number: "38", carrier: "–ê–û \"–°–¢–ö\"", route: "–î–æ–º —É—á–µ–Ω—ã—Ö - –ø–æ—Å. –¢–∞–π–º—ã—Ä" },
    { number: "40", carrier: "–ö–ü–ê–¢–ü-7", route: "–ü–æ–ª–∏–≥–æ–Ω - –¢–µ—Ö–Ω–∏–∫—É–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –∏ —Å–µ—Ä–≤–∏—Å–∞" },
    { number: "40a",carrier: "–ö–ü–ê–¢–ü-7", route: "–ü–æ–ª–∏–≥–æ–Ω - –ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–í–æ—Å—Ç–æ—á–Ω—ã–π¬ª" },
    { number: "40—Å",carrier: "–ö–ü–ê–¢–ü-7", route: "–ü–æ–ª–∏–≥–æ–Ω - —É–ª. –ú–æ—Å–∫–æ–≤—Å–∫–∞—è, 32/2" },
    { number: "43", carrier: "–û–û–û \"–í–∞–≤—É–ª–∏–Ω-–ö\"", route: "–°–µ–ª—å—Ö–æ–∑–∫–æ–º–ø–ª–µ–∫—Å - –ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–í–æ—Å—Ç–æ—á–Ω—ã–π¬ª" },
    { number: "49", carrier: "–ö–ü–ê–¢–ü-5", route: "–°–ø–æ—Ä—Ç–∫–æ–º–ø–ª–µ–∫—Å ¬´–†–∞–¥—É–≥–∞¬ª - –ö–∞—Ä–¥–∏–æ—Ü–µ–Ω—Ç—Ä" },
    { number: "50", carrier: "–ò–ü –ß–∏—Ç–∞—à–≤–∏–ª–∏ –ù. –°.", route: "–º–∫—Ä–Ω. –°–æ–ª–Ω–µ—á–Ω—ã–π - –°—Ç–µ–ª–∞" },
    { number: "52", carrier: "–ö–ü–ê–¢–ü-5", route: "–û–∑–µ—Ä–æ-–ø–∞—Ä–∫ - –º–∫—Ä–Ω. –¢–∏—Ö–∏–µ –∑–æ—Ä–∏" },
    { number: "55", carrier: "–ö–ü–ê–¢–ü-7", route: "–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π –≤–æ–∫–∑–∞–ª - –ø–æ—Å. –¶–µ–º–µ–Ω—Ç–Ω–∏–∫–æ–≤" },
    { number: "56", carrier: "–ö–ü–ê–¢–ü-7", route: "–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π –≤–æ–∫–∑–∞–ª - –ø–æ—Å. –®–∏–Ω–Ω–∏–∫–æ–≤" },
    { number: "58", carrier: "–ò–ü –ö—Ä–∏–≤–æ–Ω–æ–≥–æ–≤ –ò. –ì.", route: "–°–ø–æ—Ä—Ç–∑–∞–ª - –ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞" },
    { number: "60", carrier: "–ò–ü –¶—É–≥–ª–µ–Ω–æ–∫ –ú.–ú.", route: "–º–∫—Ä–Ω. –°–æ–ª–Ω–µ—á–Ω—ã–π - –ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–í–æ—Å—Ç–æ—á–Ω—ã–π¬ª" },
    { number: "61", carrier: "–ö–ü–ê–¢–ü", route: "–ø–æ—Å. –®–∏–Ω–Ω–∏–∫–æ–≤ - –º–∫—Ä–Ω. –°–æ–ª–Ω–µ—á–Ω—ã–π" },
    { number: "63", carrier: "–ö–ü–ê–¢–ü", route: "–ê–∫–∞–¥–µ–º–≥–æ—Ä–æ–¥–æ–∫ - –º–∫—Ä–Ω. –°–æ–ª–Ω–µ—á–Ω—ã–π" },
    { number: "64", carrier: "–ö–ü–ê–¢–ü-5", route: "–º–∫—Ä–Ω. –°–æ–ª–Ω–µ—á–Ω—ã–π - –º–∫—Ä–Ω. –¢–∏—Ö–∏–µ –∑–æ—Ä–∏" },
    { number: "65", carrier: "–ò–ü –Ø–ª—Ç–æ–Ω—Å–∫–∏–π –ê.–ú.", route: "–î–ö ¬´–ö–∏—Ä–æ–≤—Å–∫–∏–π¬ª - –ê–≥—Ä–æ—Ç–µ—Ä–º–∏–Ω–∞–ª" },
    { number: "69", carrier: "–ö–ü–ê–¢–ü-7", route: "–ò–¢–ö - –º–∫—Ä–Ω. –°–æ–ª–Ω–µ—á–Ω—ã–π" },
    { number: "71", carrier: "–û–û–û \"–≠–∫–∏–ø–∞–∂-–ì–û\"", route: "–ø–æ—Å. –¢–∞–π–º—ã—Ä - –°–ø–æ—Ä—Ç–∑–∞–ª" },
    { number: "77", carrier: "–û–û–û \"–ü—Ä–∞–∫—Ç–∏–∫\"", route: "–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω–∞—è –±–æ–ª—å–Ω–∏—Ü–∞ - –¥. –ü–µ—Å—á–∞–Ω–∫–∞" },
    { number: "78", carrier: "–ò–ü –ë—Ä–æ–Ω–Ω–∏–∫–æ–≤ –ê. –ò.", route: "–°—Ç–µ–ª–∞ - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–π –¥–≤–æ—Ä" },
    { number: "80", carrier: "–ò–ü –î–æ–ª–≥—É—à–∏–Ω –î.–ì.", route: "–º–∫—Ä–Ω. –¢–∏—Ö–∏–µ –∑–æ—Ä–∏ - –ø–æ—Å. –¢–∞–π–º—ã—Ä" },
    { number: "81", carrier: "–û–û–û \"–°–∏—Ä–µ–Ω–∞\"", route: "–û–ê–û ¬´–†–£–°–ê–õ¬ª - –ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω–∞—è –±–æ–ª—å–Ω–∏—Ü–∞" },
    { number: "83", carrier: "–ò–ü –¶—É–≥–ª–µ–Ω–æ–∫ –ú.–ú.", route: "–î–æ–º —É—á–µ–Ω—ã—Ö - –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–æ—Ä–∏–π –∑-–¥–∞ –ö—Ä–∞–ú–ó" },
    { number: "85", carrier: "–û–û–û \"–°–ö–ê–î\"", route: "–î–∞—É—Ä—Å–∫–∞—è - –°–µ–ª—å—Ö–æ–∑–∫–æ–º–ø–ª–µ–∫—Å" },
    { number: "87", carrier: "–ö–ü–ê–¢–ü-5", route: "–ú–æ–ª–æ–¥–µ–∂–Ω–∞—è - –º–∫—Ä–Ω. –°–æ–ª–Ω–µ—á–Ω—ã–π" },
    { number: "88", carrier: "–ò–ü –¢–∞–≥–∞—á–∞–∫–æ–≤ –í.–ì.", route: "–ê–∫–∞–¥–µ–º–∏—è –±–∏–∞—Ç–ª–æ–Ω–∞ - –°–ø–æ—Ä—Ç–∑–∞–ª" },
    { number: "90", carrier: "–ò–ü –ü–∞—Ç—Ä–∏–Ω –ù.–ù.", route: "–º–∫—Ä–Ω –í–µ—Ä—Ö–Ω—è—è –ë–∞–∑–∞–∏—Ö–∞ - –ê–∫–∞–¥–µ–º–∏—è –±–∏–∞—Ç–ª–æ–Ω–∞" },
    { number: "92", carrier: "–ò–ü –ü–∞—Ç—Ä–∏–Ω –ù.–ù.", route: "–•–∏–º–∫–æ–º–±–∏–Ω–∞—Ç ¬´–ï–Ω–∏—Å–µ–π¬ª - –û–ê–û ¬´–ö—Ä–∞—Å—Ñ–∞—Ä–º–∞¬ª" },
    { number: "94", carrier: "–û–û–û \"–ü—Ä–∞–∫—Ç–∏–∫\"", route: "–¢–≠–¶-3 - –õ–î–ö" },
    { number: "95", carrier: "–ö–ü–ê–¢–ü-7", route: "–º–∫—Ä–Ω. –í–µ—Ä—Ö–Ω–∏–µ –ß–µ—Ä–µ–º—É—à–∫–∏ - –õ–î–ö" },
    { number: "98", carrier: "–ò–ü –ì–Ω–µ—Ç–æ–≤ –Æ. –ù.", route: "–û–ê–û ¬´–†–£–°–ê–õ¬ª - –õ–î–ö" },
    { number: "99", carrier: "–û–û–û \"–°–¢–ö\"", route: "—É–ª. –¶–∏–º–ª—è–Ω—Å–∫–∞—è - —Å—Ç.–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫-–°–µ–≤–µ—Ä–Ω—ã–π" }
  ],
  trolleybuses: [
    { number: "4—Ç",  carrier: "–ú–ü –ì–æ—Ä–æ–¥—Å–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", route: "–°–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω—ã–π —Ä–∞–π–æ–Ω - –ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π –≤–æ–∫–∑–∞–ª" },
    { number: "5—Ç",  carrier: "–ú–ü –ì–æ—Ä–æ–¥—Å–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", route: "—Å—Ç.–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫-–°–µ–≤–µ—Ä–Ω—ã–π - –≠–∫–æ–ø–∞—Ä–∫ –ì—Ä–µ–º—è—á–∞—è –≥—Ä–∏–≤–∞" },
    { number: "6—Ç",  carrier: "–ú–ü –ì–æ—Ä–æ–¥—Å–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", route: "–£—Ç–∏–Ω—ã–π –ø–ª—ë—Å - –°—Ç—É–¥–≥–æ—Ä–æ–¥–æ–∫" },
    { number: "13—Ç", carrier: "–ú–ü –ì–æ—Ä–æ–¥—Å–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", route: "–°–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω—ã–π —Ä–∞–π–æ–Ω - –ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π –≤–æ–∫–∑–∞–ª" },
    { number: "15—Ç", carrier: "–ú–ü –ì–æ—Ä–æ–¥—Å–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", route: "–û–ê–û ¬´–†–£–°–ê–õ¬ª - –°–µ–ª—å—Ö–æ–∑–∫–æ–º–ø–ª–µ–∫—Å" }
  ],
  trams: [
    { number: "2—Ç—Ä", carrier: "–ú–ü \"–ì–æ—Ä—Ç—Ä–∞–Ω—Å\"", route: "–ø–æ—Å. –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–æ–≤ - –ö—Ä–∞—Å–¢–≠–¶" },
    { number: "4—Ç—Ä", carrier: "–ú–ü \"–ì–æ—Ä—ç–ª–µ–∫—Ç—Ä–æ—Ç—Ä–∞–Ω—Å\"", route: "–ü—Ä–µ–¥–º–æ—Å—Ç–Ω–∞—è –ø–ª–æ—â–∞–¥—å - –ö—Ä–∞—Å–¢–≠–¶" },
    { number: "5—Ç—Ä", carrier: "–ú–ü \"–ì–æ—Ä—ç–ª–µ–∫—Ç—Ä–æ—Ç—Ä–∞–Ω—Å\"", route: "–ø–æ—Å. –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–æ–≤ - –ü—Ä–µ–¥–º–æ—Å—Ç–Ω–∞—è –ø–ª–æ—â–∞–¥—å" },
    { number: "6—Ç—Ä", carrier: "–ú–ü \"–ì–æ—Ä—ç–ª–µ–∫—Ç—Ä–æ—Ç—Ä–∞–Ω—Å\"", route: "–ø–æ—Å. –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–æ–≤ - –ü—Ä–µ–¥–º–æ—Å—Ç–Ω–∞—è –ø–ª–æ—â–∞–¥—å" },
    { number: "7—Ç—Ä", carrier: "–ú–ü \"–ì–æ—Ä—ç–ª–µ–∫—Ç—Ä–æ—Ç—Ä–∞–Ω—Å\"", route: "–ü—Ä–µ–¥–º–æ—Å—Ç–Ω–∞—è –ø–ª–æ—â–∞–¥—å - –ö—Ä–∞—Å–¢–≠–¶" }
  ],
  eBuses: [
    { number: "1", carrier: "–ú–ü \"–ì–æ—Ä–æ–¥—Å–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç\"", route: "–º–∫—Ä–Ω. –¢–∏—Ö–∏–µ –∑–æ—Ä–∏ - —Å—Ç.–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫-–°–µ–≤–µ—Ä–Ω—ã–π" }
  ]
};

/* –°–ª—É–∂–µ–±–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã ‚Äî –ª–µ–Ω–∏–≤–æ –ø–æ–ª—É—á–∞–µ–º DOM-—É–∑–ª—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
function getTransportMenuOverlay() {
  return document.getElementById('transportMenuOverlay');
}
function getRoutesButtonsEl() {
  return document.getElementById('routesButtons');
}

/* –û—Ç–∫—Ä—ã—Ç—å / –∑–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é */
function openTransportMenu() {
  // —Ä–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ (–∑–∞–¥–∞—ë–º –≤–∫–ª–∞–¥–∫—É "–ê–≤—Ç–æ–±—É—Å—ã" –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é)
  renderRouteButtons('buses');
  setActiveTab('buses');

  const overlay = getTransportMenuOverlay();
  if (!overlay) {
    console.warn('openTransportMenu: transportMenuOverlay not found');
    return;
  }
  overlay.style.display = 'flex';
}

function closeTransportMenu() {
  const overlay = getTransportMenuOverlay();
  if (overlay) overlay.style.display = 'none';
}

/* –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏ */
function switchTransportTab(type) {
  renderRouteButtons(type);
  setActiveTab(type);
}

function setActiveTab(type) {
  ['buses','trolleybuses','trams','eBuses'].forEach(t => {
    const btn = document.getElementById('tab-' + t);
    if (btn) btn.classList.toggle('active', t === type);
  });
}

/* –†–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–æ–∫ —Å –Ω–æ–º–µ—Ä–∞–º–∏ ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º */
function renderRouteButtons(type) {
  const list = routesData[type] || [];
  const el = getRoutesButtonsEl();
  if (!el) {
    console.warn('renderRouteButtons: routesButtons container not found');
    return;
  }

  if (!Array.isArray(list) || list.length === 0) {
    el.innerHTML = '<div style="padding:12px;color:#aaa">–°–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø—É—Å—Ç</div>';
    return;
  }

  el.innerHTML = list.map((r, idx) => {
    // data- –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
    const num = String(r.number ?? '').replace(/</g, '&lt;'); // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞
    return `<button type="button" data-type="${type}" data-index="${idx}" onclick="selectRoute('${type}', ${idx})" aria-label="–ú–∞—Ä—à—Ä—É—Ç ${num}">${num}</button>`;
  }).join('');
}


// –ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–∞—Ä—à—Ä—É—Ç–∞
function selectRoute(type, index) {
  let selectedRoute;
  switch(type) {
    case 'buses':        selectedRoute = routesData.buses[index]; break;
    case 'trolleybuses': selectedRoute = routesData.trolleybuses[index]; break;
    case 'trams':        selectedRoute = routesData.trams[index]; break;
    case 'eBuses':       selectedRoute = routesData.eBuses[index]; break;
  }

  if (selectedRoute) {
    document.getElementById('inputCarrier').value = selectedRoute.carrier;
    document.getElementById('inputRoute').value   = selectedRoute.route;

    // –ê–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∏–ø–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    if (type === 'buses') {
      setTransportType('bus');
    } else {
      setTransportType('other');
    }

    // === LIVE: –ø—Ä–∏–≤—è–∑–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –∫ KGT ===
    const guessNum = selectedRoute?.num || selectedRoute?.title || selectedRoute?.route || '';
    __kgtSetupForNumber(guessNum); 
  }

  closeTransportMenu();
}

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
document.querySelectorAll('.transport-option').forEach(btn => {
  btn.addEventListener('click', () => {
    if (btn.disabled) return; // –µ—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    document.querySelectorAll('.transport-option').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('transportType').value = btn.dataset.type;
  });
});

// –ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–∞—Ä—à—Ä—É—Ç–∞
function selectRoute(type, index) {
  let selectedRoute;
  switch(type) {
    case 'buses': selectedRoute = routesData.buses[index]; break;
    case 'trolleybuses': selectedRoute = routesData.trolleybuses[index]; break;
    case 'trams': selectedRoute = routesData.trams[index]; break;
    case 'eBuses': selectedRoute = routesData.eBuses[index]; break;
  }

  if (selectedRoute) {
    document.getElementById('inputCarrier').value = selectedRoute.carrier;
    document.getElementById('inputRoute').value = selectedRoute.route;

    // –ê–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    if (type === 'buses') {
      setTransportType('bus');
    } else {
      setTransportType('other');
    }
  }

  closeTransportMenu();
}


function setTransportType(type) {
  const buttons = document.querySelectorAll('.transport-option');
  buttons.forEach(b => {
    b.classList.remove('active');
    if (b.dataset.type === type) {
      b.classList.add('active');
    }
    b.disabled = true; // –±–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–±–æ—Ä
  });
  document.getElementById('transportType').value = type;
}
    // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.transport-option').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.disabled) return;
      document.querySelectorAll('.transport-option').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('transportType').value = btn.dataset.type;
    });
  });
});

// –í—ã–∑—ã–≤–∞–π —ç—Ç–æ –∏–∑ selectRoute, —á—Ç–æ–±—ã –∞–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∏–ø –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±–æ—Ä
function setTransportType(type){
  const buttons = document.querySelectorAll('.transport-option');
  buttons.forEach(b => {
    b.classList.toggle('active', b.dataset.type === type);
    // –±–ª–æ–∫–∏—Ä—É–µ–º –æ–±–µ, —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –≤—ã–±–æ—Ä —Å–¥–µ–ª–∞–Ω
    b.disabled = true;
  });
  document.getElementById('transportType').value = type;
}
    /* === KGT: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è mu-kgt.ru === */
const KGT_BASE = 'https://mu-kgt.ru/informing/wap/marsh/';
let __kgtRouteMap = new Map();   // normalized number => m id
let __kgtReady = false;
let __kgtInitPromise = null;
let selectedKgtId = null;
let __kgtModalTimer = null;

// –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞: trim, toLower, –∑–∞–º–µ–Ω—è–µ–º –ª–∞—Ç–∏–Ω—Å–∫—É—é c –Ω–∞ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫—É—é —Å –∏ —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
function __kgtNormalize(s) {
  return String(s||'').trim().toLowerCase().replace(/\s+/g,'').replace(/c/g,'—Å');
}

// –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ KGT (getListRoute)
async function __kgtLoadRouteMap() {
  if (__kgtReady) return;
  if (__kgtInitPromise) return __kgtInitPromise;
  __kgtInitPromise = (async () => {
    try {
      const url = `${KGT_BASE}?action=getListRoute`;
      const txt = await fetch(url, { credentials: 'omit' }).then(r => r.text());
      let data;
      try { data = JSON.parse(txt); } catch(e) { console.warn('KGT getListRoute parse fail', txt); data = null; }
      // data may be array or object with array at data.routes / .list
      let items = [];
      if (Array.isArray(data)) items = data;
      else if (Array.isArray(data?.data)) items = data.data;
      else if (Array.isArray(data?.routes)) items = data.routes;
      else if (Array.isArray(data?.list)) items = data.list;
      else if (data && typeof data === 'object') {
        // try to extract objects with marsh_title or m
        for (const k in data) {
          if (Array.isArray(data[k])) {
            items = items.concat(data[k]);
          }
        }
      }
      __kgtRouteMap.clear();
      items.forEach(it => {
        const title = __kgtNormalize(it?.marsh_title || it?.title || it?.route_title || it?.number || '');
        const id = String(it?.m || it?.id || it?.marsh_id || it?.route_id || '').trim();
        if (title && id) __kgtRouteMap.set(title, id);
      });
      __kgtReady = true;
      console.log('KGT route map loaded, items:', __kgtRouteMap.size);
    } catch (err) {
      console.error('KGT load error', err);
      __kgtReady = false;
    }
  })();
  return __kgtInitPromise;
}

function __kgtFindIdByNumber(num) {
  if (!num) return null;
  const key = __kgtNormalize(num);
  if (__kgtRouteMap.has(key)) return __kgtRouteMap.get(key);
  // try alternative replacing —Å->c and vice versa
  const alt = key.replace(/—Å/g,'c');
  if (__kgtRouteMap.has(alt)) return __kgtRouteMap.get(alt);
  return null;
}

/* –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ KGT */
function __kgtShowButton(show) {
  const btn = document.getElementById('kgtViewBtn');
  if (!btn) return;
  btn.style.display = show ? 'inline-block' : 'none';
}

/* –í—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ UI –≤—ã–±—Ä–∞–ª –º–∞—Ä—à—Ä—É—Ç (–∏–ª–∏ –º—ã –º–æ–∂–µ–º –≤—ã–∑—ã–≤–∞—Ç—å –∏–∑ selectRoute) */
async function __kgtSetupForNumber(num) {
  if (!num) {
    selectedKgtId = null;
    __kgtShowButton(false);
    return;
  }
  await __kgtLoadRouteMap();
  const id = __kgtFindIdByNumber(num);
  if (id) {
    selectedKgtId = id;
    __kgtShowButton(true);
    console.log('KGT: found id', id, 'for', num);
  } else {
    selectedKgtId = null;
    __kgtShowButton(false);
    console.log('KGT: no id found for', num);
  }
}

/* –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ id (m) */
async function __kgtFetchMarshData(m) {
  if (!m) return null;
  try {
    const url = `${KGT_BASE}?m=${encodeURIComponent(m)}&action=getMarshData`;
    const txt = await fetch(url, { credentials: 'omit' }).then(r => r.text());
    try { return JSON.parse(txt); } catch (e) { console.warn('KGT marsh parse fail', txt.slice(0,200)); return null; }
  } catch (err) {
    console.error('KGT fetch error', err);
    return null;
  }
}

/* –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ */
async function openKgtModal() {
  const modal = document.getElementById('kgtModal');
  const title = document.getElementById('kgtModalRoute');
  const body = document.getElementById('kgtModalBody');
  
  if (!modal || !title || !body) {
    console.error('KGT modal elements not found');
    alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞');
    return;
  }
  
  // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–º–µ—Ä –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const carrierText = document.getElementById('inputCarrier').value || '';
  const routeText = document.getElementById('inputRoute').value || '';
  const routeNumber = extractRouteNumber(routeText) || extractRouteNumber(carrierText) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
  
  title.textContent = `–ú–∞—Ä—à—Ä—É—Ç ${routeNumber}`;
  body.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
  
  modal.style.display = 'flex';
  console.log('KGT modal opened for route:', routeNumber);
  
  // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
  await kgtRefreshNow();
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
  if (__kgtModalTimer) clearInterval(__kgtModalTimer);
  __kgtModalTimer = setInterval(kgtRefreshNow, 15000);
}

function closeKgtModal() {
  const modal = document.getElementById('kgtModal');
  if (modal) modal.style.display = 'none';
  if (__kgtModalTimer) {
    clearInterval(__kgtModalTimer);
    __kgtModalTimer = null;
  }
}

/* —Ä—É—á–Ω–æ–π —Ç—Ä–∏–≥–≥–µ—Ä */
async function kgtRefreshNow() {
  const body = document.getElementById('kgtModalBody');
  const updatedSpan = document.getElementById('kgtModalUpdated');
  
  if (!body) {
    console.error('KGT modal body not found');
    return;
  }
  
  // –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–æ–∫–∞ CORS –Ω–µ —Ä–µ—à—ë–Ω)
  const routeText = document.getElementById('inputRoute').value || '–¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç';
  const carrierText = document.getElementById('inputCarrier').value || '–ö–ü–ê–¢–ü-5';
  const routeNumber = extractRouteNumber(routeText) || extractRouteNumber(carrierText) || '11';
  
  console.log('KGT: Showing mock data for route', routeNumber);
  
 const mockData = await getMockKgtData(routeNumber, routeText);
  body.innerHTML = renderKgtData(mockData) + 
    '<div style="color:#ffa726;font-size:12px;margin-top:10px;">üìä –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>';
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
  const now = new Date();
  if (updatedSpan) {
    updatedSpan.textContent = now.toLocaleTimeString('ru-RU', {
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
  }
}

/* –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –º–æ–¥–∞–ª–∫–∏ */
async function __kgtRefreshModal() {
  const body = document.getElementById('kgtModalBody');
  const updated = document.getElementById('kgtModalUpdated');
  if (!selectedKgtId) {
    body.innerHTML = 'ID –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
    return;
  }
  body.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
  const data = await __kgtFetchMarshData(selectedKgtId);
  if (!data) {
    body.innerHTML = '<div style="color:#f88">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
    updated.textContent = '';
    return;
  }

  // –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
  const sb = [];
  // directions A/B
  if (data.directions) {
    ['A','B'].forEach(dirKey => {
      const dir = data.directions[dirKey];
      if (!dir) return;
      sb.push(`<div class="kgt-direction">`);
      sb.push(`<div class="kgt-dir-title">${(dir.first||dir.title||'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ '+dirKey)} ‚Üí ${(dir.last||'‚Äî')}</div>`);

      // –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ ‚Äî –∏—â–µ–º –º–∞—Å—Å–∏–≤ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö
      const stops = dir.stations || dir.stops || dir.items || dir.list || [];
      if (Array.isArray(stops) && stops.length>0) {
        sb.push('<ul class="kgt-stops">');
        stops.forEach(s => {
          const name = s.title || s.name || s.stop || s.station || '‚Äî';
          const time = s.time || s.arrival || s.forecast || s.forecast_time || s.next || '‚Äî';
          sb.push(`<li><span class="kgt-stop-name">${escapeHtml(name)}</span><span class="kgt-stop-time">${escapeHtml(String(time))}</span></li>`);
        });
        sb.push('</ul>');
      } else {
        sb.push('<div style="color:#aaa">–û—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –¥–∞–Ω–Ω—ã—Ö</div>');
      }
      sb.push('</div>');
    });
  } else {
    // –ø–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ stops –≤ –∫–æ—Ä–Ω–µ
    const stops = data.stations || data.stops || data.items || [];
    if (Array.isArray(stops) && stops.length) {
      sb.push('<div class="kgt-direction"><div class="kgt-dir-title">–û—Å—Ç–∞–Ω–æ–≤–∫–∏</div><ul class="kgt-stops">');
      stops.forEach(s => {
        const name = s.title || s.name || s.stop || '‚Äî';
        const time = s.time || s.arrival || s.forecast || s.next || '‚Äî';
        sb.push(`<li><span class="kgt-stop-name">${escapeHtml(name)}</span><span class="kgt-stop-time">${escapeHtml(String(time))}</span></li>`);
      });
      sb.push('</ul></div>');
    } else {
      sb.push('<div style="color:#aaa">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>');
    }
  }

  // –ü–æ–∏—â–µ–º —Å–ø–∏—Å–æ–∫ –¢–° (vehicles)
  let vehicles = data.transport || data.transport_list || data.vehicles || data.ts || data.transport_on_route || [];
  // –µ—Å–ª–∏ vehicles –ø—É—Å—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∫–ª—é—á–∞–º–∏ 'num' –∏–ª–∏ 'ts_guid' ‚Äì –≥—Ä—É–±—ã–π —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –º–∞—Å—Å–∏–≤–∞
  if ((!vehicles || vehicles.length===0) && typeof data === 'object') {
    vehicles = findFirstArrayWithObjects(data) || [];
  }

  if (Array.isArray(vehicles) && vehicles.length>0) {
    sb.push('<div class="kgt-vehicles"><div style="font-weight:700;margin-bottom:6px">–ê–≤—Ç–æ–±—É—Å—ã –Ω–∞ –ª–∏–Ω–∏–∏</div>');
    vehicles.forEach(v=>{
      const left = (v.number||v.title||v.v || v.name || v.id) ;
      // –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å —Ü–µ–ª–µ–≤—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∏–ª–∏ –±–ª–∏–∂–∞–π—à—É—é
      const right = v.stop || v.stop_title || v.next_stop || v.to_stop || v.arrival || v.next || v.target || '‚Äî';
      sb.push(`<div class="kgt-vehicle"><div class="v-left">${escapeHtml(String(left||'‚Äî'))}</div><div class="v-right">${escapeHtml(String(right))}</div></div>`);
    });
    sb.push('</div>');
  }

  body.innerHTML = sb.join('');
  updated.textContent = '–æ–±–Ω–æ–≤–ª–µ–Ω–æ ' + (data.forecast||new Date().toLocaleTimeString());
}

/* —É—Ç–∏–ª–∏—Ç—ã: –Ω–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ (–≥–ª—É–±–æ–∫–∏–π –æ–±—Ö–æ–¥, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ) */
function findFirstArrayWithObjects(obj, depth=0) {
  if (!obj || depth>6) return null;
  if (Array.isArray(obj) && obj.length>0 && typeof obj[0] === 'object') return obj;
  if (typeof obj !== 'object') return null;
  for (const k in obj) {
    try {
      const res = findFirstArrayWithObjects(obj[k], depth+1);
      if (res) return res;
    } catch(e){}
  }
  return null;
}

/* –ø—Ä–æ—Å—Ç–∞—è HTML-escape */
function escapeHtml(s) {
  return String(s||'').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}

/* –∫–æ–Ω–µ—Ü –±–ª–æ–∫–∞ KGT */

    const originalSelectRoute = window.selectRoute;
if (originalSelectRoute) {
  window.selectRoute = function(type, index) {
    // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    originalSelectRoute(type, index);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É KGT –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ª—é–±–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
    setTimeout(() => {
      __kgtShowButton(true);
      selectedKgtId = 'demo'; // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º demo ID
      console.log('KGT button activated for route selection');
    }, 100);
  };
}

// === –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –° CORS –ü–†–û–ö–°–ò ===
async function getMockKgtData(routeNumber, fullRoute) {
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π CORS –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    const CORS_PROXY = 'https://corsproxy.io/?';
    const BASE_URL = 'https://mu-kgt.ru/informing/wap/marsh/';
    
    console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ ${routeNumber}...`);
    
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ ID
    const listUrl = `${CORS_PROXY}${encodeURIComponent(BASE_URL + '?action=getListRoute')}`;
    const listResponse = await fetch(listUrl);
    
    if (!listResponse.ok) {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤');
    }
    
    const routesList = await listResponse.json();
    console.log('–°–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø–æ–ª—É—á–µ–Ω:', routesList);
    
    // –ò—â–µ–º ID –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É
    let routeId = null;
    if (Array.isArray(routesList)) {
      const route = routesList.find(r => 
        r.marsh_title === routeNumber || 
        r.title === routeNumber ||
        r.marsh_title === `${routeNumber}–∞` ||
        r.marsh_title === `${routeNumber}—Å`
      );
      if (route) {
        routeId = route.m || route.marsh_id;
      }
    }
    
    if (!routeId) {
      console.log(`ID –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞ ${routeNumber} –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–º–µ—Ä –∫–∞–∫ ID`);
      routeId = routeNumber;
    }
    
    // –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
    const dataUrl = `${CORS_PROXY}${encodeURIComponent(BASE_URL + '?m=' + routeId + '&action=getMarshData')}`;
    console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞:', dataUrl);
    
    const dataResponse = await fetch(dataUrl);
    
    if (!dataResponse.ok) {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞');
    }
    
    const routeData = await dataResponse.json();
    console.log('–î–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ–ª—É—á–µ–Ω—ã:', routeData);
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    if (routeData) {
      const result = {
        direction_A: null,
        direction_B: null,
        vehicles: []
      };
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      if (routeData.A) {
        result.direction_A = {
          name: `${routeData.A.first || '–ù–∞—á–∞–ª—å–Ω–∞—è'} ‚Üí ${routeData.A.last || '–ö–æ–Ω–µ—á–Ω–∞—è'}`,
          stops: []
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è A
        if (routeData.A.stations && Array.isArray(routeData.A.stations)) {
          result.direction_A.stops = routeData.A.stations.map(station => ({
            name: station.title || station.name || '–û—Å—Ç–∞–Ω–æ–≤–∫–∞',
            time: station.forecast || station.arival || '‚Äî'
          }));
        }
      }
      
      if (routeData.B) {
        result.direction_B = {
          name: `${routeData.B.first || '–ù–∞—á–∞–ª—å–Ω–∞—è'} ‚Üí ${routeData.B.last || '–ö–æ–Ω–µ—á–Ω–∞—è'}`,
          stops: []
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è B
        if (routeData.B.stations && Array.isArray(routeData.B.stations)) {
          result.direction_B.stops = routeData.B.stations.map(station => ({
            name: station.title || station.name || '–û—Å—Ç–∞–Ω–æ–≤–∫–∞',
            time: station.forecast || station.arival || '‚Äî'
          }));
        }
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ –Ω–∞ –ª–∏–Ω–∏–∏
      if (routeData.ts && Array.isArray(routeData.ts)) {
        result.vehicles = routeData.ts.map(vehicle => ({
          id: vehicle.v || vehicle.title || vehicle.num || '–Ω/–¥',
          location: vehicle.stop || vehicle.station || '–≤ –ø—É—Ç–∏',
          time: vehicle.arival || '—Ä–∞—Å—á—ë—Ç...'
        }));
      }
      
      console.log('–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', result);
      return result;
    }
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–∞–π—Ç–∞:', error);
    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤');
  }
  
  // === –†–ï–ó–ï–†–í–ù–´–ï –õ–û–ö–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï (–µ—Å–ª–∏ —Å–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω) ===
  const localRoutes = {
    '11': {
      direction_A: {
        name: "3-—è –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è ‚Üí –ú–æ–ª–æ–¥–µ–∂–Ω–∞—è",
        stops: [
          {name: "3-—è –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è", time: "0 –º–∏–Ω"},
          {name: "–°–æ–ª–Ω–µ—á–Ω–∞—è", time: "2 –º–∏–Ω"},
          {name: "1-—è –•–∞–±–∞—Ä–æ–≤—Å–∫–∞—è", time: "3 –º–∏–Ω"},
          {name: "2-—è –•–∞–±–∞—Ä–æ–≤—Å–∫–∞—è", time: "4 –º–∏–Ω"},
          {name: "–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è", time: "5 –º–∏–Ω"},
          {name: "–î–æ–º –°–æ–≤–µ—Ç–æ–≤", time: "6 –º–∏–Ω"},
          {name: "–î—É–±—Ä–æ–≤–∏–Ω—Å–∫–æ–≥–æ", time: "7 –º–∏–Ω"},
          {name: "—É–ª. –ú–∞–µ—Ä—á–∞–∫–∞", time: "8 –º–∏–Ω"},
          {name: "–î–æ–º –±—ã—Ç–∞ (–ú–µ–º–æ—Ä–∏–∞–ª)", time: "9 –º–∏–Ω"},
          {name: "–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Ç–µ–∞—Ç—Ä", time: "10 –º–∏–Ω"},
          {name: "–¢–µ–∞—Ç—Ä –ü—É—à–∫–∏–Ω–∞", time: "11 –º–∏–Ω"},
          {name: "–§–∏–ª–∞—Ä–º–æ–Ω–∏—è", time: "12 –º–∏–Ω"},
          {name: "–ø–ª. –†–µ–≤–æ–ª—é—Ü–∏–∏", time: "13 –º–∏–Ω"},
          {name: "–ö–ò–¶", time: "14 –º–∏–Ω"},
          {name: "—É–ª. –°—É—Ä–∏–∫–æ–≤–∞", time: "15 –º–∏–Ω"},
          {name: "–ì–ª–∞–≤–ø–æ—á—Ç–∞–º—Ç", time: "16 –º–∏–Ω"},
          {name: "—É–ª. –õ–µ–Ω–∏–Ω–∞", time: "17 –º–∏–Ω"},
          {name: "–¢–µ–∞—Ç—Ä –æ–ø–µ—Ä—ã –∏ –±–∞–ª–µ—Ç–∞", time: "18 –º–∏–Ω"},
          {name: "–ú–æ–ª–æ–¥–µ–∂–Ω–∞—è", time: "20 –º–∏–Ω"}
        ]
      },
      direction_B: {
        name: "–ú–æ–ª–æ–¥–µ–∂–Ω–∞—è ‚Üí 3-—è –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è", 
        stops: [
          {name: "–ú–æ–ª–æ–¥–µ–∂–Ω–∞—è", time: "0 –º–∏–Ω"},
          {name: "–¢–µ–∞—Ç—Ä –æ–ø–µ—Ä—ã –∏ –±–∞–ª–µ—Ç–∞", time: "2 –º–∏–Ω"},
          {name: "—É–ª. –õ–µ–Ω–∏–Ω–∞", time: "3 –º–∏–Ω"},
          {name: "–ì–ª–∞–≤–ø–æ—á—Ç–∞–º—Ç", time: "4 –º–∏–Ω"},
          {name: "—É–ª. –°—É—Ä–∏–∫–æ–≤–∞", time: "5 –º–∏–Ω"},
          {name: "–ö–ò–¶", time: "6 –º–∏–Ω"},
          {name: "–ø–ª. –†–µ–≤–æ–ª—é—Ü–∏–∏", time: "7 –º–∏–Ω"},
          {name: "–§–∏–ª–∞—Ä–º–æ–Ω–∏—è", time: "8 –º–∏–Ω"},
          {name: "–¢–µ–∞—Ç—Ä –ü—É—à–∫–∏–Ω–∞", time: "9 –º–∏–Ω"},
          {name: "–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Ç–µ–∞—Ç—Ä", time: "10 –º–∏–Ω"},
          {name: "–î–æ–º –±—ã—Ç–∞ (–ú–µ–º–æ—Ä–∏–∞–ª)", time: "11 –º–∏–Ω"},
          {name: "—É–ª. –ú–∞–µ—Ä—á–∞–∫–∞", time: "12 –º–∏–Ω"},
          {name: "–î—É–±—Ä–æ–≤–∏–Ω—Å–∫–æ–≥–æ", time: "13 –º–∏–Ω"},
          {name: "–î–æ–º –°–æ–≤–µ—Ç–æ–≤", time: "14 –º–∏–Ω"},
          {name: "–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è", time: "15 –º–∏–Ω"},
          {name: "2-—è –•–∞–±–∞—Ä–æ–≤—Å–∫–∞—è", time: "16 –º–∏–Ω"},
          {name: "1-—è –•–∞–±–∞—Ä–æ–≤—Å–∫–∞—è", time: "17 –º–∏–Ω"},
          {name: "–°–æ–ª–Ω–µ—á–Ω–∞—è", time: "18 –º–∏–Ω"},
          {name: "3-—è –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è", time: "20 –º–∏–Ω"}
        ]
      },
      vehicles: []
    }
  };
  
  return localRoutes[routeNumber] || {
    direction_A: {
      name: fullRoute || `–ú–∞—Ä—à—Ä—É—Ç ${routeNumber}`,
      stops: [
        {name: "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏", time: "‚Äî"},
        {name: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É", time: "‚Äî"}
      ]
    },
    vehicles: []
  };
}
    document.addEventListener('DOMContentLoaded', function() {
  console.log('KGT system initialized');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ
  const requiredElements = ['kgtModal', 'kgtModalRoute', 'kgtModalBody', 'kgtViewBtn'];
  const missing = requiredElements.filter(id => !document.getElementById(id));
  
  if (missing.length > 0) {
    console.warn('Missing KGT elements:', missing);
  } else {
    console.log('All KGT elements found ‚úì');
  }
});
    // === –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ –í –í–ê–® –ö–û–î ===

/* –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ */
function extractRouteNumber(routeString) {
  if (!routeString || typeof routeString !== 'string') return '';
  
  console.log('Extracting route number from:', routeString);
  
  // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –Ω–æ–º–µ—Ä –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö:
  
  // 1. –í –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏: "11 - –º–∞—Ä—à—Ä—É—Ç" –∏–ª–∏ "11—Å"
  let match = routeString.match(/^(\d+[–∞-—è—ë]*)/i);
  if (match) {
    console.log('Found route number at start:', match[1]);
    return match[1];
  }
  
  // 2. –ü–æ—Å–ª–µ —Å–ª–æ–≤–∞ "–º–∞—Ä—à—Ä—É—Ç": "–∞–≤—Ç–æ–±—É—Å –º–∞—Ä—à—Ä—É—Ç 11"
  match = routeString.match(/–º–∞—Ä—à—Ä—É—Ç\s*(\d+[–∞-—è—ë]*)/i);
  if (match) {
    console.log('Found route number after "–º–∞—Ä—à—Ä—É—Ç":', match[1]);
    return match[1];
  }
  
  // 3. –í –Ω–∞–∑–≤–∞–Ω–∏–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞: "–ö–ü–ê–¢–ü-5"
  match = routeString.match(/–ö–ü–ê–¢–ü[- ]?(\d+)/i);
  if (match) {
    console.log('Found route number in carrier name:', match[1]);
    return match[1];
  }
  
  // 4. –õ—é–±—ã–µ —Ü–∏—Ñ—Ä—ã —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏: "–∞–≤—Ç–æ–±—É—Å 11–∞ –µ–¥–µ—Ç"
  match = routeString.match(/(\d+[–∞-—è—ë]*)/i);
  if (match) {
    console.log('Found route number anywhere:', match[1]);
    return match[1];
  }
  
  // 5. –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
  console.log('No route number found in:', routeString);
  return '';
}

// === –£–õ–£–ß–®–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò KGT (—Å –ª—É—á—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫) ===

/* –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è openKgtModal */
async function openKgtModal() {
  const modal = document.getElementById('kgtModal');
  const title = document.getElementById('kgtModalRoute');
  const body = document.getElementById('kgtModalBody');
  
  if (!modal || !title || !body) {
    console.error('KGT modal elements not found');
    alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞');
    return;
  }
  
  try {
    // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–º–µ—Ä –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const carrierText = document.getElementById('inputCarrier')?.value || '';
    const routeText = document.getElementById('inputRoute')?.value || '';
    const plateText = document.getElementById('inputPlate')?.value || '';
    
    console.log('Opening KGT modal with data:', {
      carrier: carrierText,
      route: routeText,  
      plate: plateText
    });
    
    // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –Ω–æ–º–µ—Ä –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª–µ–π
    let routeNumber = extractRouteNumber(routeText);
    if (!routeNumber) routeNumber = extractRouteNumber(carrierText);
    if (!routeNumber) routeNumber = extractRouteNumber(plateText);
    if (!routeNumber) routeNumber = '–î–µ–º–æ';
    
    title.textContent = `–ú–∞—Ä—à—Ä—É—Ç ${routeNumber}`;
    body.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
    
    modal.style.display = 'flex';
    console.log('KGT modal opened for route:', routeNumber);
    
    // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    await kgtRefreshNow();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    if (window.__kgtModalTimer) clearInterval(window.__kgtModalTimer);
    window.__kgtModalTimer = setInterval(kgtRefreshNow, 30000);
    
  } catch (error) {
    console.error('Error in openKgtModal:', error);
    body.innerHTML = `<div style="color:#ff6b6b;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
  }
}

/* –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è kgtRefreshNow */
async function kgtRefreshNow() {
  const body = document.getElementById('kgtModalBody');
  const updatedSpan = document.getElementById('kgtModalUpdated');
  
  if (!body) {
    console.error('KGT modal body not found');
    return;
  }
  
  try {
    // –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    const routeText = document.getElementById('inputRoute')?.value || '–¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç';
    const carrierText = document.getElementById('inputCarrier')?.value || '–ö–ü–ê–¢–ü-5';
    const routeNumber = extractRouteNumber(routeText) || extractRouteNumber(carrierText) || '–î–µ–º–æ';
    
    console.log('KGT: Refreshing data for route', routeNumber);
    
    const mockData = getMockKgtData(routeNumber, routeText);
    body.innerHTML = renderKgtData(mockData) + 
      '<div style="color:#4caf50;font-size:12px;margin-top:10px;text-align:center;">üìä –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Ä¢ –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫</div>';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
    const now = new Date();
    if (updatedSpan) {
      updatedSpan.textContent = now.toLocaleTimeString('ru-RU', {
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
    }
    
  } catch (error) {
    console.error('Error in kgtRefreshNow:', error);
    body.innerHTML = `<div style="color:#ff6b6b;">–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${error.message}</div>`;
  }
}

// === –¢–ï–°–¢–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–†–û–í–ï–†–ö–ò ===
function testKgtSystem() {
  console.log('=== KGT System Test ===');
  
  // –¢–µ—Å—Ç extractRouteNumber
  const testStrings = [
    '11 - –∞–≤—Ç–æ–±—É—Å',
    '–ö–ü–ê–¢–ü-5',
    '3-—è –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è - –ú–æ–ª–æ–¥–µ–∂–Ω–∞—è',
    '–ú–∞—Ä—à—Ä—É—Ç 22—Å',
    '–≤447—Ä—Ä124',
    ''
  ];
  
  testStrings.forEach(str => {
    const result = extractRouteNumber(str);
    console.log(`"${str}" ‚Üí "${result}"`);
  });
  
  // –¢–µ—Å—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  console.log('Opening test modal...');
  selectedKgtId = 'test';
  openKgtModal();
}

// –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏
window.testKgtSystem = testKgtSystem;


/* === –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø KGT –°–ò–°–¢–ï–ú–´ === */
/* –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –ü–ï–†–ï–î –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º script */

/* 1. –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–∞ */
function extractRouteNumber(routeString) {
  if (!routeString || typeof routeString !== 'string') return '';
  
  // 1. –í –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏: "11 - –º–∞—Ä—à—Ä—É—Ç" –∏–ª–∏ "11—Å"
  let match = routeString.match(/^(\d+[–∞-—è—ë]*)/i);
  if (match) return match[1];
  
  // 2. –ü–æ—Å–ª–µ —Å–ª–æ–≤–∞ "–º–∞—Ä—à—Ä—É—Ç": "–∞–≤—Ç–æ–±—É—Å –º–∞—Ä—à—Ä—É—Ç 11"
  match = routeString.match(/–º–∞—Ä—à—Ä—É—Ç\s*(\d+[–∞-—è—ë]*)/i);
  if (match) return match[1];
  
  // 3. –í –Ω–∞–∑–≤–∞–Ω–∏–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞: "–ö–ü–ê–¢–ü-5"
  match = routeString.match(/–ö–ü–ê–¢–ü[- ]?(\d+)/i);
  if (match) return match[1];
  
  // 4. –õ—é–±—ã–µ —Ü–∏—Ñ—Ä—ã —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏
  match = routeString.match(/(\d+[–∞-—è—ë]*)/i);
  if (match) return match[1];
  
  return '';
}

function renderKgtData(data) {
  if (!data) return '<div style="color:#ff6b6b;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–∞—Ä—à—Ä—É—Ç–µ</div>';
  
  let html = '';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
  const directions = [];
  if (data.direction_A) directions.push(data.direction_A);
  if (data.direction_B) directions.push(data.direction_B);
  
  // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  if (directions.length === 0 && data.directions) {
    directions.push(...data.directions);
  }
  
  if (directions.length === 0) {
    return '<div style="color:#ff6b6b;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –º–∞—Ä—à—Ä—É—Ç–∞</div>';
  }
  
  directions.forEach((dir, idx) => {
    const dirLabel = idx === 0 ? '–ü—Ä—è–º–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ' : '–û–±—Ä–∞—Ç–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ';
    const iconLabel = idx === 0 ? '‚Üí' : '‚Üê';
    
    html += `<div class="kgt-direction" style="margin-bottom: 20px;">`;
    html += `<div class="kgt-dir-title" style="background: #1a1a1a; padding: 10px; border-radius: 8px; margin-bottom: 10px;">`;
    html += `<strong style="color: #e21a1a;">${iconLabel}</strong> ${dir.name || dirLabel}`;
    html += `</div>`;
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∏
    const stops = dir.stops || [];
    if (stops.length > 0) {
      const maxHeight = stops.length > 10 ? 'max-height: 400px; overflow-y: auto;' : '';
      html += `<ul class="kgt-stops" style="list-style: none; padding: 0; margin: 0; ${maxHeight}">`;
      
      stops.forEach((stop, stopIdx) => {
        const name = stop.name || '–û—Å—Ç–∞–Ω–æ–≤–∫–∞';
        const time = stop.time || '‚Äî';
        
        const isTerminal = stopIdx === 0 || stopIdx === stops.length - 1;
        const bgColor = isTerminal ? '#2a2a2a' : '#1d1d1d';
        const borderColor = isTerminal ? '#e21a1a' : '#262626';
        
        html += `<li style="display: flex; justify-content: space-between; gap: 10px; padding: 10px; border-radius: 8px; background: ${bgColor}; border: 1px solid ${borderColor}; margin-bottom: 6px;">`;
        html += `<div class="kgt-stop-name" style="color: #fff; font-weight: ${isTerminal ? '700' : '600'};">`;
        
        if (isTerminal) {
          html += stopIdx === 0 ? 'üö© ' : 'üèÅ ';
        }
        
        html += `${name}</div>`;
        html += `<div class="kgt-stop-time" style="color: #ff6b6b; font-weight: 700;">${time}</div>`;
        html += `</li>`;
      });
      html += `</ul>`;
    } else {
      html += '<div style="color:#aaa; padding: 10px;">–°–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
    }
    
    html += `</div>`;
  });
  
  // –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–∞ –ª–∏–Ω–∏–∏
  const vehicles = data.vehicles || [];
  if (vehicles.length > 0) {
    html += `<div class="kgt-vehicles" style="margin-top: 15px; padding: 12px; background: #151515; border: 1px dashed #333; border-radius: 8px;">`;
    html += `<div style="font-weight: 700; margin-bottom: 8px; color: #fff;">üöå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–∞ –ª–∏–Ω–∏–∏:</div>`;
    
    vehicles.forEach(vehicle => {
      const id = vehicle.id || vehicle.v || vehicle.title || '–Ω/–¥';
      const location = vehicle.stop || vehicle.location || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      const time = vehicle.time || '—Å–µ–π—á–∞—Å';
      
      html += `<div style="display: flex; justify-content: space-between; padding: 8px 0;">`;
      html += `<div style="color: #fff; font-weight: 700;">–ê–≤—Ç–æ–±—É—Å ${id}</div>`;
      html += `<div style="color: #ff8b8b;">${location} ‚Ä¢ ${time}</div>`;
      html += `</div>`;
    });
    html += `</div>`;
  }
  
  return html;
}

/* 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
async function openKgtModal() {
  const modal = document.getElementById('kgtModal');
  const title = document.getElementById('kgtModalRoute');
  const body = document.getElementById('kgtModalBody');
  
  if (!modal || !title || !body) {
    alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞');
    return;
  }
  
  try {
    const carrierText = document.getElementById('inputCarrier')?.value || '';
    const routeText = document.getElementById('inputRoute')?.value || '';
    
    let routeNumber = extractRouteNumber(routeText);
    if (!routeNumber) routeNumber = extractRouteNumber(carrierText);
    if (!routeNumber) routeNumber = '–î–µ–º–æ';
    
    title.textContent = `–ú–∞—Ä—à—Ä—É—Ç ${routeNumber}`;
    body.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
    
    modal.style.display = 'flex';
    console.log('KGT modal opened for route:', routeNumber);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    setTimeout(() => {
      const mockData = {
        directions: [{
          name: `–ú–∞—Ä—à—Ä—É—Ç ${routeNumber}: ${routeText || '–¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç'}`,
          stops: [
            {name: "3-—è –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è", time: "2 –º–∏–Ω"},
            {name: "—É–ª. –ú–∞–µ—Ä—á–∞–∫–∞", time: "5 –º–∏–Ω"}, 
            {name: "–¢–µ–∞—Ç—Ä –ü—É—à–∫–∏–Ω–∞", time: "8 –º–∏–Ω"},
            {name: "–ø–ª. –†–µ–≤–æ–ª—é—Ü–∏–∏", time: "11 –º–∏–Ω"},
            {name: "—É–ª. –õ–µ–Ω–∏–Ω–∞", time: "14 –º–∏–Ω"},
            {name: "–ú–æ–ª–æ–¥–µ–∂–Ω–∞—è", time: "17 –º–∏–Ω"}
          ],
          vehicles: [
            {id: "1147", location: "–ø–ª. –†–µ–≤–æ–ª—é—Ü–∏–∏", time: "3 –º–∏–Ω –Ω–∞–∑–∞–¥"},
            {id: "1203", location: "—É–ª. –ú–∞–µ—Ä—á–∞–∫–∞", time: "1 –º–∏–Ω –Ω–∞–∑–∞–¥"}
          ]
        }]
      };
      
      body.innerHTML = renderKgtData(mockData) + 
        '<div style="color:#4caf50;font-size:12px;margin-top:10px;text-align:center;">üìä –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Ä¢ –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫</div>';
        
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
      const updatedSpan = document.getElementById('kgtModalUpdated');
      if (updatedSpan) {
        const now = new Date();
        updatedSpan.textContent = now.toLocaleTimeString('ru-RU', {
          hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
      }
    }, 500);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    if (window.__kgtModalTimer) clearInterval(window.__kgtModalTimer);
    window.__kgtModalTimer = setInterval(() => {
      console.log('KGT: Auto-refreshing data...');
      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    }, 30000);
    
  } catch (error) {
    console.error('Error in openKgtModal:', error);
    body.innerHTML = `<div style="color:#ff6b6b;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
  }
}

/* 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ closeApp –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ */
const originalCloseApp = window.closeApp;
if (originalCloseApp) {
  window.closeApp = function() {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä KGT –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    if (window.__kgtModalTimer) {
      clearInterval(window.__kgtModalTimer);
      window.__kgtModalTimer = null;
    }
    
    // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    try {
      originalCloseApp();
    } catch (error) {
      console.log('Error in original closeApp, using fallback');
      // –§–æ–ª–ª–±—ç–∫-–ª–æ–≥–∏–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
      clearInterval(countdownInterval);
      inputScreen.classList.add('active');
      mainScreen.classList.remove('active');
      
      // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
      ['inputCarrier', 'inputRoute', 'inputPlate', 'inputFare', 'inputCount'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
      });
      
      switchTab('ticket');
    }
  };
}

console.log('‚úÖ KGT —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É
// === TELEGRAM INTEGRATION ===

// –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞
function toggleTelegramMode() {
    const toggle = document.getElementById('sendToTelegram');
    const button = document.getElementById('sendToBot');
    
    if (toggle && toggle.checked) {
        button.style.display = 'block';
    } else {
        button.style.display = 'none';
    }
}

// –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –Ω—É–∂–Ω—ã–º–∏ ID
function sendDataToTelegramBot() {
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ü–†–ê–í–ò–õ–¨–ù–´–• –ø–æ–ª–µ–π
    const ticketData = {
        carrier: document.getElementById('inputCarrier').value || '–ö–ü–ê–¢–ü-5',
        routeNumber: extractRouteNumberForBot(),
        routeName: document.getElementById('inputRoute').value || '3-—è –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è - –ú–æ–ª–æ–¥–µ–∂–Ω–∞—è',
        busNumber: document.getElementById('inputPlate').value || generateRandomPlate(),
        price: calculatePrice(),
        count: document.getElementById('inputCount').value || '1',
        transportType: document.getElementById('transportType').value
    };
    
    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:', ticketData);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Telegram
    if (window.Telegram && window.Telegram.WebApp) {
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
            window.Telegram.WebApp.sendData(JSON.stringify(ticketData));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            window.Telegram.WebApp.showAlert('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —á–∞—Ç!');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç—É–º–±–ª–µ—Ä
            document.getElementById('sendToTelegram').checked = false;
            toggleTelegramMode();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
        }
    } else {
        // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
        console.log('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º. –î–∞–Ω–Ω—ã–µ:', ticketData);
        alert('–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Telegram!\n–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:\n' + JSON.stringify(ticketData, null, 2));
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function extractRouteNumberForBot() {
    const route = document.getElementById('inputRoute').value;
    let match = route.match(/^(\d+[–∞-—èa-z]*)/i);
    if (match) return match[1];
    match = route.match(/(\d+)/);
    return match ? match[1] : '85';
}

function generateRandomPlate() {
    const letters = '–∞–≤–µ–∫–º–Ω–æ—Ä—Å—Ç—É—Ö';
    const l1 = letters[Math.floor(Math.random() * letters.length)];
    const nums = Math.floor(Math.random() * 900) + 100;
    const l2 = letters[Math.floor(Math.random() * letters.length)];
    const l3 = letters[Math.floor(Math.random() * letters.length)];
    const region = ['124', '24', '125', '724'][Math.floor(Math.random() * 4)];
    return `${l1}${nums}${l2}${l3}${region}`;
}

function calculatePrice() {
    const count = parseInt(document.getElementById('inputCount').value) || 1;
    const type = document.getElementById('transportType').value;
    const pricePerTicket = type === 'bus' ? 48 : 40;
    return (count * pricePerTicket).toFixed(2);
}

// –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≥–æ—Å–Ω–æ–º–µ—Ä–∞
function generateBusNumber() {
    const letters = ['—É', '–∞', '–º', '–∫', '–µ', '—Ç', '–æ', '—Ä', '–Ω', '—Ö', '—Å'];
    const regions = ['124', '24', '125', '724'];
    
    const letter1 = letters[Math.floor(Math.random() * letters.length)];
    const numbers = Math.floor(Math.random() * 900) + 100;
    const letter2 = letters[Math.floor(Math.random() * letters.length)];
    const letter3 = letters[Math.floor(Math.random() * letters.length)];
    const region = regions[Math.floor(Math.random() * regions.length)];
    
    return `${letter1}${numbers}${letter2}${letter3}${region}`;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL (–¥–ª—è —Ä–µ–∂–∏–º–∞ –ø–æ–∫–∞–∑–∞ –±–∏–ª–µ—Ç–∞)
function handleTicketMode() {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.get('mode') === 'ticket') {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç–∞ –∏–∑ URL
        document.getElementById('ticketNumber').textContent = urlParams.get('ticketNumber');
        document.getElementById('carrier').textContent = urlParams.get('carrier');
        document.getElementById('route').textContent = `${urlParams.get('routeNumber')} ${urlParams.get('routeName')}`;
        document.getElementById('busNumber').textContent = urlParams.get('busNumber');
        document.getElementById('price').textContent = `${urlParams.get('tariff')} ${urlParams.get('price')} ‚ÇΩ`;
        document.getElementById('purchaseTime').textContent = urlParams.get('purchaseTime');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∏–ª–µ—Ç
        showTicketView();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
window.Telegram.WebApp.ready();
window.Telegram.WebApp.expand();

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', handleTicketMode);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        function toggleSendButton() {
            const toggle = document.getElementById('sendToBot');
            const button = document.getElementById('sendButton');
            
            if (toggle.checked) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É

      //    function sendDataToBot() {
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        //    const data = {
           //     carrier: document.getElementById('carrier').value,
         //       routeNumber: document.getElementById('routeNumber').value,
           //     routeName: document.getElementById('routeName').value,
           //     busNumber: document.getElementById('busNumber').value,
           //     price: document.getElementById('price').value
       //     };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç—É
      //      tg.sendData(JSON.stringify(data));
     //       
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   //         tg.showAlert('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∞—Ç.');
//        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—ç—à–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∏–ª–µ—Ç–∞
        function checkForTicket() {
            const hash = window.location.hash;
            if (hash.startsWith('#ticket=')) {
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                const encodedData = hash.substring(8);
                try {
                    const decodedData = atob(encodedData);
                    const ticketData = JSON.parse(decodedData);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∏–ª–µ—Ç
                    showTicket(ticketData);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', e);
                }
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –±–∏–ª–µ—Ç
        function showTicket(data) {
            document.getElementById('formView').style.display = 'none';
            document.getElementById('ticketView').classList.add('active');
            
            document.getElementById('ticketNumber').textContent = `–ë–∏–ª–µ—Ç ‚Ññ${data.ticketNumber}`;
            document.getElementById('ticketCarrier').textContent = `üè¢ ${data.carrier}`;
            document.getElementById('ticketRoute').textContent = `üöè ${data.routeNumber} ${data.routeName}`;
            document.getElementById('ticketBus').textContent = `üöå ${data.busNumber}`;
            document.getElementById('ticketPrice').textContent = `üí∞ –ü–æ–ª–Ω—ã–π ${data.price} ‚ÇΩ`;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', checkForTicket);
        
        // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≥–æ—Å–Ω–æ–º–µ—Ä–∞ (–µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ)
        document.getElementById('busNumber').addEventListener('blur', function() {
            if (!this.value) {
                const letters = '–ê–í–ï–ö–ú–ù–û–†–°–¢–£–•';
                const l1 = letters[Math.floor(Math.random() * letters.length)];
                const nums = Math.floor(Math.random() * 900) + 100;
                const l2 = letters[Math.floor(Math.random() * letters.length)];
                const l3 = letters[Math.floor(Math.random() * letters.length)];
                const region = Math.floor(Math.random() * 90) + 10;
                this.value = `${l1}${nums}${l2}${l3}${region}`;
            }
        });
  </script>
  
</div>
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
  <div class="loader"></div>
</div>
  
</body>
</html>
